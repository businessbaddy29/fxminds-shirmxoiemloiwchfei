<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure Slip — Amount per Slip</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:transparent;color:#0d2433;}
body::before{content:"";position:fixed;inset:0;z-index:-3;background-image:url("truck.avif");background-size:cover;background-position:center;filter:blur(6px) brightness(.95);}
body::after{content:"";position:fixed;inset:0;z-index:-2;background:linear-gradient(rgba(255,255,255,0.66),rgba(255,255,255,0.66));}
.container{max-width:1100px;margin:22px auto;padding-bottom:60px;}
.card{background:linear-gradient(180deg,#fff,#fbfdff);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(22,40,60,0.06);border:1px solid rgba(10,18,30,0.04);margin-bottom:18px;}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;}
.btn-blue{background:linear-gradient(180deg,#1976d2,#0b63b3);color:#fff;}
.btn-ghost{background:transparent;border:1px solid rgba(10,18,30,0.06);color:#07304b;}
.amount-input{width:100px;padding:6px;font-family:monospace;}
.amount-submit{padding:6px 8px;margin-left:6px;}
.table{width:100%;border-collapse:collapse;margin-top:8px;}
.table th,.table td{padding:8px 6px;text-align:left;border-bottom:1px solid rgba(10,18,30,0.04);font-size:13px;vertical-align:middle;}
/* slip styles */
#slipOutput{display:none;position:fixed;left:50%;top:6%;transform:translateX(-50%);width:min(880px,96%);max-height:88vh;overflow:auto;z-index:9999;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,0.35);background:transparent;}
#slipInner{background:#fff;padding:18px;border-radius:8px;color:#000;font-family:"Courier New",monospace;box-sizing:border-box;}
.slip-wrapper{white-space:pre;font-family:"Courier New",monospace;color:#000;}
.slip-firm{text-align:center;font-weight:700;font-size:18px;margin-bottom:6px;}
.slip-address{text-align:center;font-size:12px;margin-bottom:6px;color:#333;}
.big-val{font-weight:700;font-size:15px;}
@media print{body *{visibility:hidden!important;}#slipOutput,#slipOutput *{visibility:visible!important;}#slipOutput{position:absolute!important;left:0!important;top:0!important;width:100%!important;margin:0!important;padding:10mm!important;background:#fff!important;box-shadow:none!important;} }
</style>
</head>
<body>

<div class="container">
  <div class="card loginBox" id="loginBox">
    <h2>Login</h2>
    <input id="username" placeholder="User ID" />
    <input id="password" type="password" placeholder="Password" />
    <button id="loginBtn" class="btn btn-blue">Login</button>
    <p id="loginErr" style="color:#d33;display:none;">Invalid credentials</p>
  </div>

  <div class="card" id="formCard" style="display:none;">
    <form id="slipForm" onsubmit="return false;">
      <label>Firm Name: <input type="text" id="firmName" value="FIRM NAME" required></label>
      <label>Firm Address: <input type="text" id="firmAddress" value="FIRM ADDRESS"></label>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <label>RST No: <input type="text" id="rstNo" value="101"></label>
        <label>Vehicle No: <input type="text" id="vehicleNo" value="RJ32GE0903"></label>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
        <label>Gross (weight): <input type="text" id="gross" value="70680 Kg"></label>
        <label>Gross Date: <input type="text" id="grossDate" value="29/07/2025"></label>
      </div>

      <div style="margin-top:10px;">
        <label>Net: <input type="text" id="net" value="54980 Kg"></label>
      </div>

      <div style="margin-top:12px;">
        <button type="button" id="printBtn" class="btn btn-blue">Print Slip & Save</button>
        <button type="button" id="previewBtn" class="btn btn-ghost">Preview Slip</button>
      </div>
    </form>
  </div>

  <div class="card" id="dashboardCard" style="display:none;">
    <div style="font-weight:700;margin-bottom:8px;">Saved Slips</div>
    <table class="table"><thead><tr><th>Sr</th><th>Date</th><th>Vehicle</th><th>Amount</th><th>Action</th></tr></thead><tbody id="recordsBody"></tbody></table>
  </div>
</div>

<div id="slipOutput" role="dialog" aria-modal="true">
  <div style="display:flex;justify-content:flex-end;padding:8px;"><button id="closePreviewBtn" class="btn btn-blue">Close</button></div>
  <div id="slipInner"><div id="slipContent" style="color:#000;"></div></div>
</div>

<script>
/* Minimal DB (indexedDB helpers) */
const DB_NAME='secure_slips_db_v1', STORE_NAME='slips';
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,2); r.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)){ const s=db.createObjectStore(STORE_NAME,{keyPath:'id',autoIncrement:true}); s.createIndex('savedAt','savedAt',{unique:false}); } }; r.onsuccess=e=>res(e.target.result); r.onerror=e=>rej(e.target.error); }); }
async function addSlipToDB(record){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); const store=tx.objectStore(STORE_NAME); const req=store.add(record); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); }
async function getAllSlips(){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readonly'); const store=tx.objectStore(STORE_NAME); const req=store.getAll(); req.onsuccess=()=>res(req.result.sort((a,b)=>a.id-b.id)); req.onerror=()=>rej(req.error); }); }

/* small escape */
function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ====== buildSlipHtml (FIXED placeholder replacement) ====== */
function buildSlipHtml(data){
  const width = 80;
  function padCenterText(text){
    const t = String(text || '');
    const left = Math.floor((width - t.length)/2);
    const right = width - t.length - left;
    return ' '.repeat(Math.max(0,left)) + t + ' '.repeat(Math.max(0,right));
  }
  const grossVal = data.gross || '';
  const tareVal = data.tare || '';
  const netVal = data.net || '';

  // Build plain text with placeholders (no escaping yet)
  let lines = '';
  lines += padCenterText(data.firmName || '') + '\n';
  lines += padCenterText(data.firmAddress || '') + '\n';
  lines += '.'.repeat(width) + '\n';
  lines += (`RST No.     : ${data.rstNo || ''}`).padEnd(40) + (`Vehicle No.   : ${data.vehicleNo || ''}`) + '\n';
  lines += (`Vehicle Type: ${data.vehicleType || ''}`).padEnd(40) + (`Party Name    : ${data.partyName || ''}`) + '\n';
  lines += (`Address     : ${data.address || ''}`).padEnd(40) + (`Item          : ${data.item || ''}`) + '\n';
  lines += '.'.repeat(width) + '\n';
  lines += (`Gross :    <<GROSS>>`).padEnd(25) + (` Date: ${data.grossDate || ''}`).padEnd(20) + (`  Time: ${data.grossTime || ''}`) + '\n';
  lines += (`Tare  :    <<TARE>>`).padEnd(25) + (` Date: ${data.tareDate || ''}`).padEnd(20) + (`  Time: ${data.tareTime || ''}`) + '\n';
  lines += (`Net   :    <<NET>>`) + '\n';
  lines += '.'.repeat(width) + '\n';
  if(data.amount !== undefined && data.amount !== null && data.amount !== ''){
    lines += (`Amount :    ₹ ${data.amount}`).padEnd(width) + '\n';
    lines += '.'.repeat(width) + '\n';
  }
  lines += (`Charges    : Rs ${data.charges || ''}`) + '\n';
  lines += '.'.repeat(width) + '\n';
  lines += (`                                  Phone : ${data.phone || ''}`) + '\n';
  lines += padCenterText('Thanks for your visit') + '\n';

  // Escape entire rest, then replace escaped placeholder tokens with span-wrapped escaped values
  const allLines = lines.split('\n');
  const firmLine = allLines[0] || '';
  const addressLine = allLines[1] || '';
  const rest = allLines.slice(2).join('\n');

  // escape rest (placeholders become &lt;&lt;GROSS&gt;&gt; etc)
  const restEsc = esc(rest);

  // Replace escaped placeholders with span elements containing escaped actual values
  const withGross = restEsc.replaceAll('&lt;&lt;GROSS&gt;&gt;', `<span class="big-val">${esc(grossVal)}</span>`);
  const withTare = withGross.replaceAll('&lt;&lt;TARE&gt;&gt;', `<span class="big-val">${esc(tareVal)}</span>`);
  const withNet = withTare.replaceAll('&lt;&lt;NET&gt;&gt;', `<span class="big-val">${esc(netVal)}</span>`);

  // Compose HTML: firm and address are shown as centered bold parts (escaped)
  const html = `
    <div>
      <div class="slip-firm">${esc(data.firmName || '')}</div>
      <div class="slip-address">${esc(data.firmAddress || '')}</div>
      <pre class="slip-wrapper">${withNet}</pre>
    </div>
  `;
  return html;
}

/* render preview */
function renderSlipPreview(rec){
  document.getElementById('slipContent').innerHTML = buildSlipHtml(rec);
  document.getElementById('slipOutput').style.display = 'block';
  document.getElementById('slipOutput').scrollIntoView({behavior:'smooth'});
}

/* close preview */
document.getElementById('closePreviewBtn').addEventListener('click', ()=> document.getElementById('slipOutput').style.display='none');

/* collect form */
function collectForm(){
  return {
    firmName: document.getElementById('firmName').value,
    firmAddress: document.getElementById('firmAddress').value,
    rstNo: document.getElementById('rstNo').value,
    vehicleNo: document.getElementById('vehicleNo').value,
    vehicleType: '',
    partyName: '',
    address: '',
    item: '',
    gross: document.getElementById('gross').value,
    grossDate: document.getElementById('grossDate').value,
    grossTime: '',
    tare: '',
    tareDate: '',
    tareTime: '',
    net: document.getElementById('net').value,
    charges: '',
    phone: '123456',
    savedAt: new Date().toISOString()
  };
}

/* Print / Save */
document.getElementById('printBtn').addEventListener('click', async ()=>{
  const rec = collectForm();
  const id = await addSlipToDB(rec);
  rec.id = id;
  // show preview (user asked earlier to remove download/print from preview — still showing preview; printing handled by user)
  renderSlipPreview(rec);
});

/* preview only */
document.getElementById('previewBtn').addEventListener('click', ()=>{
  const rec = collectForm();
  renderSlipPreview(rec);
});

/* refresh list */
async function refreshList(){
  const all = await getAllSlips();
  const body = document.getElementById('recordsBody');
  body.innerHTML = '';
  all.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.vehicleNo||'-'}</td><td>${new Date(r.savedAt).toLocaleDateString()}</td><td>${r.amount?('₹'+r.amount):''}</td><td><button class="btn btn-ghost" data-id="${r.id}">View</button></td>`;
    body.appendChild(tr);
  });
  body.querySelectorAll('button').forEach(b=> b.onclick = (e)=>{
    const id = Number(e.currentTarget.dataset.id);
    const rec = all.find(x=>x.id===id);
    if(rec) renderSlipPreview(rec);
  });
}

/* init UI */
window.addEventListener('load', ()=>{
  document.getElementById('formCard').style.display='none';
  document.getElementById('dashboardCard').style.display='none';
});

/* simple login to show UI */
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if(u==='FxMiNds' && p==='Sk@#9136332836@'){
    document.getElementById('loginBox').style.display='none';
    document.getElementById('formCard').style.display='block';
    document.getElementById('dashboardCard').style.display='block';
    await refreshList();
  } else {
    document.getElementById('loginErr').style.display='block';
    setTimeout(()=>document.getElementById('loginErr').style.display='none',2000);
  }
});
</script>
</body>
</html>
