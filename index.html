<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure Slip — Amount per Slip</title>

<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ===== Base & background ===== */
html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:transparent; color:#0d2433; }
body::before{
  content:""; position: fixed; inset:0; z-index:-3;
  background-image: url("truck.avif"); background-size:cover; background-position:center; filter: blur(6px) brightness(.95);
}
body::after{
  content:""; position: fixed; inset:0; z-index:-2;
  background: linear-gradient(rgba(255,255,255,0.66), rgba(255,255,255,0.66));
}

.container { max-width:1100px; margin:22px auto; padding-bottom:60px; }

/* Card */
.card { background: linear-gradient(180deg,#fff,#fbfdff); padding:16px; border-radius:12px; box-shadow:0 8px 30px rgba(22,40,60,0.06); border:1px solid rgba(10,18,30,0.04); margin-bottom:18px; }

/* Login */
.loginBox h2 { margin:0 0 12px 0; color:#0b2330; font-size:20px; }
.loginBox input { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid rgba(20,30,40,0.06); font-family:"Courier New", monospace; }
.loginBox button { width:100%; padding:10px; border-radius:8px; border:none; background:#0b63b3; color:#fff; font-weight:600; cursor:pointer; }

/* Form full-width */
.form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:center; }
label { display:block; color:#0b2330; font-size:14px; margin-top:8px; }
input[type="text"], input[type="date"], select { width:100%; padding:8px; border-radius:6px; border:1px solid rgba(20,30,40,.06); font-family:"Courier New", monospace; box-sizing:border-box; }

/* Both times row */
.time-row { display:flex; gap:8px; }
.time-row input { flex:1; }

/* Buttons & print settings */
.controls { display:flex; gap:8px; margin-top:10px; align-items:center; }
.btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
.btn-blue { background: linear-gradient(180deg,#1976d2,#0b63b3); color:#fff; }
.btn-ghost { background:transparent; border:1px solid rgba(10,18,30,0.06); color:#07304b; }

/* Slip preview overlay (Close only) */
#slipOutput {
  display:none;
  position: fixed;
  left: 50%;
  top: 6%;
  transform: translateX(-50%);
  width: min(880px, 96%);
  max-height: 88vh;
  overflow:auto;
  z-index: 9999;
  border-radius:8px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.35);
  background: transparent;
}
#previewToolbar { display:flex; gap:8px; padding:8px; justify-content:flex-end; background: rgba(12,20,30,0.03); border-top-left-radius:8px; border-top-right-radius:8px; }

/* inside slip card */
#slipInner { background: #fff; padding: 18px; border-radius: 8px; color:#000; font-family: "Courier New", monospace; box-sizing:border-box; }

/* styling for slip content elements */
.slip-wrapper { white-space: pre; font-family: "Courier New", monospace; color:#000; }
.slip-firm { text-align:center; font-weight:700; font-size:18px; margin-bottom:6px; }
.slip-address { text-align:center; font-size:12px; margin-bottom:6px; color:#333; }
.big-val { font-weight:700; font-size:15px; }

/* Print fallback CSS */
@media print {
  body * { visibility: hidden !important; }
  #slipOutput, #slipOutput * { visibility: visible !important; }
  #slipOutput { position: absolute !important; left:0 !important; top:0 !important; width:100% !important; margin:0 !important; padding:10mm !important; background:#fff !important; box-shadow:none !important; }
  #previewToolbar { display:none !important; }
}

/* responsive */
@media (max-width:720px){
  .form-grid { grid-template-columns: 1fr; }
  .time-row { flex-direction:column; }
  #slipOutput { top:4%; }
}
.amount-input { width:100px; padding:6px; font-family: monospace; }
.amount-submit { padding:6px 8px; margin-left:6px; }
.total-box { font-weight:700; padding:8px; background:#f2f8ff; border-radius:8px; display:inline-block; }
</style>
</head>
<body>

<div class="container">

  <!-- LOGIN -->
  <div class="card loginBox" id="loginBox">
    <h2>Login</h2>
    <input id="username" placeholder="User ID" autocomplete="off" />
    <input id="password" placeholder="Password" type="password" autocomplete="off" />
    <button id="loginBtn" class="btn btn-blue">Login</button>
    <p id="loginErr" style="color:#d33; display:none; margin-top:8px;">Invalid credentials</p>
  </div>

  <!-- FORM -->
  <div class="card" id="formCard" style="display:none;">
    <form id="slipForm" onsubmit="return false;">
      <label>Firm Name: <input type="text" id="firmName" value="FIRM NAME" required></label>
      <label>Firm Address: <input type="text" id="firmAddress" value="FIRM ADDRESS"></label>

      <div class="form-grid">
        <label>RST No: <input type="text" id="rstNo" value="101"></label>
        <label>Vehicle No: <input type="text" id="vehicleNo" value="RJ32GE0903"></label>
      </div>

      <div class="form-grid">
        <label>Vehicle Type: <input type="text" id="vehicleType"></label>
        <label>Party Name: <input type="text" id="partyName"></label>
      </div>

      <div class="form-grid">
        <label>Address: <input type="text" id="address"></label>
        <label>Item: <input type="text" id="item" value="20MM"></label>
      </div>

      <div class="form-grid">
        <label>Gross (weight): <input type="text" id="gross" value="70680 Kg"></label>
        <label>Gross Date: <input type="text" id="grossDate" value="29/07/2025"></label>
      </div>

      <!-- BOTH TIMES -->
      <div class="time-row" style="margin-top:6px;">
        <div style="flex:1">
          <label>Gross Time (enter exactly): <input type="text" id="grossTime" placeholder="e.g. 13:37"></label>
        </div>
        <div style="flex:1">
          <label>Tare Time (enter exactly): <input type="text" id="tareTime" placeholder="e.g. 13:45"></label>
        </div>
      </div>

      <div class="form-grid">
        <label>Tare (weight): <input type="text" id="tare" value="15700 Kg"></label>
        <label>Tare Date: <input type="text" id="tareDate" value="29/07/2025"></label>
      </div>

      <label>Net: <input type="text" id="net" value="54980 Kg"></label>
      <label>Charges: Rs <input type="text" id="charges" value="0"></label>
      <label>Phone: <input type="text" id="phone" value="123456"></label>

      <!-- PRINT SETTINGS UI -->
      <div style="display:flex; gap:10px; align-items:center; margin-top:12px;">
        <div class="print-options">
          <label>Orientation</label>
          <select id="printOrientation">
            <option value="portrait">Portrait</option>
            <option value="landscape">Landscape</option>
          </select>
        </div>

        <div class="print-options">
          <label>Paper</label>
          <select id="printPaper">
            <option value="a4">A4</option>
            <option value="letter">Letter</option>
          </select>
        </div>

        <div class="print-options">
          <label>Margins</label>
          <select id="printMargin">
            <option value="8">Default (8mm)</option>
            <option value="4">Small (4mm)</option>
            <option value="0">None (0mm)</option>
          </select>
        </div>

        <div class="print-options">
          <label>Scale</label>
          <select id="printScale">
            <option value="1">100%</option>
            <option value="0.95">95%</option>
            <option value="0.9">90%</option>
          </select>
        </div>
      </div>

      <div class="controls">
        <button type="button" id="printBtn" class="btn btn-blue">Print Slip & Save</button>
        <button type="button" id="previewBtn" class="btn btn-ghost">Preview Slip</button>
        <button type="button" id="logoutBtn" class="btn btn-ghost" style="margin-left:auto">Logout</button>
      </div>
    </form>
  </div>

</div>

<!-- Slip preview overlay (Close only) -->
<div id="slipOutput" role="dialog" aria-modal="true">
  <div id="previewToolbar">
    <button id="closePreviewBtn" class="btn btn-blue">Close</button>
  </div>

  <div id="slipInner">
    <div id="slipContent" style="color:#000;"></div>
  </div>
</div>

<script>
/* ====== (Removed) IndexedDB and Google-Sheets sending code per request ====== */
/* All storage (saved slips) and sheet-sending functionality removed.
   Only preview / PDF generation / print logic remains. */

/* ==================== UI state & elements ==================== */
const USERNAME = "FxMiNds";
const PASSWORD = "Sk@#9136332836@";
let isLoggedIn=false;

const loginBtn = document.getElementById('loginBtn');
const loginErr = document.getElementById('loginErr');
const loginBox = document.getElementById('loginBox');
const formCard = document.getElementById('formCard');

const mainPrintBtn = document.getElementById('printBtn');
const previewBtn = document.getElementById('previewBtn');
const logoutBtn = document.getElementById('logoutBtn');

const slipOutput = document.getElementById('slipOutput');
const slipContent = document.getElementById('slipContent');

const closePreviewBtn = document.getElementById('closePreviewBtn');

/* Print controls */
const printOrientation = document.getElementById('printOrientation');
const printPaper = document.getElementById('printPaper');
const printMargin = document.getElementById('printMargin');
const printScale = document.getElementById('printScale');

/* ====== login/logout ====== */
loginBtn.addEventListener('click', async () => {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if(u === USERNAME && p === PASSWORD){
    isLoggedIn = true;
    loginBox.style.display = 'none';
    formCard.style.display = 'block';
  } else {
    loginErr.style.display = 'block';
    setTimeout(()=>loginErr.style.display='none',2000);
  }
});
logoutBtn.addEventListener('click', () => {
  isLoggedIn = false;
  loginBox.style.display = 'block';
  formCard.style.display = 'none';
  slipOutput.style.display = 'none';
  document.getElementById('username').value='';
  document.getElementById('password').value='';
});

/* ====== collect form ====== */
function collectForm(){
  return {
    firmName: document.getElementById('firmName').value,
    firmAddress: document.getElementById('firmAddress').value,
    rstNo: document.getElementById('rstNo').value,
    vehicleNo: document.getElementById('vehicleNo').value,
    vehicleType: document.getElementById('vehicleType').value,
    partyName: document.getElementById('partyName').value,
    address: document.getElementById('address').value,
    item: document.getElementById('item').value,
    gross: document.getElementById('gross').value,
    grossDate: document.getElementById('grossDate').value,
    grossTime: document.getElementById('grossTime')?.value || '',
    tare: document.getElementById('tare').value,
    tareDate: document.getElementById('tareDate')?.value || '',
    tareTime: document.getElementById('tareTime')?.value || '',
    net: document.getElementById('net').value,
    charges: document.getElementById('charges').value,
    phone: document.getElementById('phone').value,
    savedAt: new Date().toISOString()
  };
}

/* ====== build slip HTML (includes styled firm + big values) ====== */
function buildSlipHtml(data){
  const width = 80;
  function padCenterText(text){
    const t = String(text || '');
    const left = Math.floor((width - t.length)/2);
    const right = width - t.length - left;
    return ' '.repeat(Math.max(0,left)) + t + ' '.repeat(Math.max(0,right));
  }
  const grossVal = data.gross || '';
  const tareVal = data.tare || '';
  const netVal = data.net || '';

  let lines = '';
  lines += padCenterText(data.firmName || '') + '\n';
  lines += padCenterText(data.firmAddress || '') + '\n';
  lines += '.'.repeat(width) + '\n';
  lines += (`RST No.     : ${data.rstNo || ''}`).padEnd(40) + (`Vehicle No.   : ${data.vehicleNo || ''}`) + '\n';
  lines += (`Vehicle Type: ${data.vehicleType || ''}`).padEnd(40) + (`Party Name    : ${data.partyName || ''}`) + '\n';
  lines += (`Address     : ${data.address || ''}`).padEnd(40) + (`Item          : ${data.item || ''}`) + '\n';
  lines += '.'.repeat(width) + '\n';
  lines += (`Gross :    <<GROSS>>`).padEnd(25) + (` Date: ${data.grossDate || ''}`).padEnd(20) + (`  Time: ${data.grossTime || ''}`) + '\n';
  lines += (`Tare  :    <<TARE>>`).padEnd(25) + (` Date: ${data.tareDate || ''}`).padEnd(20) + (`  Time: ${data.tareTime || ''}`) + '\n';
  lines += (`Net   :    <<NET>>`) + '\n';
  lines += '.'.repeat(width) + '\n';
  if(data.amount !== undefined && data.amount !== null && data.amount !== ''){
    lines += (`Amount :    ₹ ${data.amount}`).padEnd(width) + '\n';
    lines += '.'.repeat(width) + '\n';
  }
  lines += (`Charges    : Rs ${data.charges || ''}`) + '\n';
  lines += '.'.repeat(width) + '\n';
  lines += (`                                  Phone : ${data.phone || ''}`) + '\n';
  lines += padCenterText('Thanks for your visit') + '\n';

  const allLines = lines.split('\n');
  const firmLine = allLines[0] || '';
  const addressLine = allLines[1] || '';
  const rest = allLines.slice(2).join('\n');

  function esc(s){ return String(s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  const restEsc = esc(rest);
  const withGross = restEsc.replaceAll('&lt;&lt;GROSS&gt;&gt;', `<span class="big-val">${esc(grossVal)}</span>`);
  const withTare = withGross.replaceAll('&lt;&lt;TARE&gt;&gt;', `<span class="big-val">${esc(tareVal)}</span>`);
  const withNet = withTare.replaceAll('&lt;&lt;NET&gt;&gt;', `<span class="big-val">${esc(netVal)}</span>`);

  const html = `
    <div>
      <div class="slip-firm">${esc(data.firmName || '')}</div>
      <div class="slip-address">${esc(data.firmAddress || '')}</div>
      <pre class="slip-wrapper">${withNet}</pre>
    </div>
  `;
  return html;
}

/* ====== render preview (use innerHTML since we now return HTML) ====== */
function renderSlipPreview(rec){
  document.getElementById('slipContent').innerHTML = buildSlipHtml(rec);
  slipOutput.style.display = 'block';
  slipOutput.scrollIntoView({behavior:'smooth'});
}

/* ====== preview close ====== */
closePreviewBtn.addEventListener('click', ()=> slipOutput.style.display='none');

/* ====== PDF generation (as before) ====== */
async function generatePdfAndOpen(rec){
  document.getElementById('slipContent').innerHTML = buildSlipHtml(rec);
  slipOutput.style.display = 'block';
  const orientation = printOrientation?.value || 'portrait';
  const paper = printPaper?.value || 'a4';
  const marginMM = Number(printMargin?.value || 8);
  const scaleFactor = Number(printScale?.value || 1);
  const canvas = await html2canvas(document.getElementById('slipInner'), { scale: 2 * scaleFactor, useCORS:true, allowTaint:false });
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'mm', format: paper, orientation: orientation });
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = pdf.internal.pageSize.getHeight();
  const usableW = pdfWidth - (marginMM*2);
  const usableH = pdfHeight - (marginMM*2);
  const img = new Image();
  img.src = imgData;
  await new Promise(res => img.onload = res);
  const imgW = img.width;
  const imgH = img.height;
  const imgRatio = imgW / imgH;
  let drawW = usableW;
  let drawH = drawW / imgRatio;
  if(drawH > usableH){
    drawH = usableH;
    drawW = drawH * imgRatio;
  }
  const x = (pdfWidth - drawW) / 2;
  const y = (pdfHeight - drawH) / 2;
  pdf.addImage(imgData, 'PNG', x, y, drawW, drawH);
  const blob = pdf.output('blob');
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
}

/* ====== Print button (only preview/PDF) ====== */
document.getElementById('printBtn').addEventListener('click', async ()=>{
  if(!isLoggedIn){ alert('Please login first'); return; }
  const rec = collectForm();

  // Note: persistent save and sheet-sync removed per request.
  await generatePdfAndOpen(rec);
});

/* preview only */
previewBtn.addEventListener('click', ()=>{
  if(!isLoggedIn){ alert('Please login first'); return; }
  const rec = collectForm();
  renderSlipPreview(rec);
});

/* initial UI state */
window.addEventListener('load', ()=>{
  formCard.style.display='none';
  slipOutput.style.display='none';
});
</script>

</body>
</html>
