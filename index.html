<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Slip Editor — WORKING (fixed)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--mono:"Courier New",monospace}
  body{font-family:Inter,system-ui,Arial; margin:12px; background:#f4f6f8;}
  .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:420px 1fr;gap:12px;}
  .panel{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  label{display:block;font-family:var(--mono);margin-top:8px;font-size:13px}
  input[type=text],input[type=number]{width:100%;padding:8px;box-sizing:border-box;font-family:var(--mono)}
  .btn{padding:8px 10px;border-radius:6px;border:none;cursor:pointer;font-weight:700}
  .btn-blue{background:#0b63b3;color:#fff}
  #slipInner{background:#fff;padding:12px;border-radius:6px;font-family:var(--mono);width:10in;height:4in;box-sizing:border-box}
  pre{white-space:pre;font-family:var(--mono);line-height:1.05}
  @media(max-width:900px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>

<div style="max-width:1100px;margin:0 auto 12px">
  <h2 style="font-family:var(--mono)">Slip Editor — Fixed</h2>
  <p style="color:#333">Edit fields and click Preview. When ready: Download Template or Create PDF (10in×4in).</p>
</div>

<div class="wrap">
  <div class="panel">
    <label>Firm name</label><input id="firmName" type="text" value="MODI AGGREGATE SOLUTION">
    <label>Firm address</label><input id="firmAddress" type="text" value="NEAR RAIPUR MOD  TEH  NEEMKATHANA">
    <label>RST No</label><input id="rstNo" type="text" value="101">
    <label>Vehicle No</label><input id="vehicleNo" type="text" value="RJ32GE0903">
    <label>Vehicle Type</label><input id="vehicleType" type="text" value="Vh l   typ.">
    <label>Party name</label><input id="partyName" type="text" value="Cash">
    <label>Address</label><input id="address" type="text" value="">
    <label>Item</label><input id="item" type="text" value="20MM">

    <hr>

    <label>Gross</label><input id="gross" type="text" value="76190 Kg">
    <label>Gross Date</label><input id="grossDate" type="text" value="02/11/2025">
    <label>Gross Time</label><input id="grossTime" type="text" value="13:45">
    <label>Tare</label><input id="tare" type="text" value="16600 Kg">
    <label>Tare Date</label><input id="tareDate" type="text" value="02/11/2025">
    <label>Tare Time</label><input id="tareTime" type="text" value="13:45">
    <label>Net</label><input id="net" type="text" value="59590 Kg">

    <label>Charges</label><input id="charges" type="text" value="0">
    <label>Phone</label><input id="phone" type="text" value="123456">

    <label>Dotted length</label><input id="dotLength" type="number" value="96" min="30" max="300">
    <label>Font size (px)</label><input id="fontSize" type="number" value="14" min="9" max="22">

    <div style="margin-top:10px">
      <button id="previewBtn" class="btn btn-blue">Preview</button>
      <button id="downloadTpl" class="btn" style="margin-left:8px">Download Template</button>
      <button id="createPdfBtn" class="btn btn-blue" style="margin-left:8px">Create PDF</button>
    </div>
  </div>

  <div class="panel">
    <h3 style="margin-top:0;font-family:var(--mono)">Preview (10in × 4in)</h3>
    <div id="slipInner"><pre id="slipContent" style="font-size:14px"></pre></div>
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
      <button id="openPreviewTab" class="btn">Open Preview</button>
      <button id="clearPreview" class="btn">Clear</button>
    </div>
  </div>
</div>

<script>
(function(){
  // helper selectors and utilities
  const q = id => document.getElementById(id);
  function stripKg(s){ return String(s||'').replace(/\s*Kg\s*$/i,'').trim(); }
  function S(n){ return n>0? ' '.repeat(n): '' }

  function buildText(){
    const dotLen = Math.max(30, Number(q('dotLength').value||96));
    const dots = '.'.repeat(dotLen);
    const width = dotLen;
    const center = txt => {
      const t = String(txt||''); const left = Math.max(0, Math.floor((width - t.length)/2));
      return S(left)+t;
    };
    // collect fields
    const firmName = q('firmName').value||'';
    const firmAddress = q('firmAddress').value||'';
    const rstNo = q('rstNo').value||'';
    const vehicleNo = q('vehicleNo').value||'';
    const vehicleType = q('vehicleType').value||'';
    const partyName = q('partyName').value||'';
    const address = q('address').value||'';
    const item = q('item').value||'';
    const gross = stripKg(q('gross').value||'0');
    const grossDate = q('grossDate').value||'';
    const grossTime = q('grossTime').value||'';
    const tare = stripKg(q('tare').value||'0');
    const tareDate = q('tareDate').value||'';
    const tareTime = q('tareTime').value||'';
    const net = stripKg(q('net').value||'0');
    const charges = q('charges').value||'0';
    const phone = q('phone').value||'';

    let out = '';
    out += center(firmName) + '\n';
    out += center(firmAddress) + '\n';
    out += dots + '\n';
    out += `RST No.     : ${rstNo}${S(8)}Vehicle No. : ${vehicleNo}\n`;
    out += `Vh l typ.   : ${vehicleType}${S(6)}Party name  : ${partyName}\n`;
    out += `Address     : ${address}${S(10)}Item        : ${item}\n`;
    out += dots + '\n';
    out += `Gross : ${S(8)}${gross}  Kg${S(6)}Date : ${grossDate}${S(6)}Time : ${grossTime}\n`;
    out += `Tare  : ${S(8)}${tare}  Kg${S(6)}Date : ${tareDate}${S(6)}Time : ${tareTime}\n`;
    out += `Net   : ${S(8)}${net}  Kg\n`;
    out += dots + '\n';
    out += `Charges : Rs ${charges}\n`;
    out += dots + '\n\n';
    out += S(10) + `Phone : ${phone}\n\n`;
    out += S(6) + `Thanks for your visit\n`;
    return out;
  }

  function render(){
    const fontSize = Math.max(9, Number(q('fontSize').value||14));
    q('slipContent').style.fontSize = fontSize + 'px';
    q('slipContent').textContent = buildText();
  }

  // bind inputs to live render
  ['firmName','firmAddress','rstNo','vehicleNo','vehicleType','partyName','address','item','gross','grossDate','grossTime','tare','tareDate','tareTime','net','charges','phone','dotLength','fontSize']
  .forEach(id => {
    const el = q(id);
    if(el) el.addEventListener('input', render);
  });

  // preview / clear
  q('previewBtn').addEventListener('click', render);
  q('clearPreview').addEventListener('click', ()=> q('slipContent').textContent = '');

  // Open preview in new tab (SAFE: no inline scripts added)
  q('openPreviewTab').addEventListener('click', ()=> {
    render();
    const safe = q('slipContent').textContent.replaceAll('&','&amp;').replaceAll('<','&lt;');
    const html = '<!doctype html><html><head><meta charset="utf-8"><title>preview</title><style>body{font-family:"Courier New",monospace;white-space:pre;padding:12px}</style></head><body><pre>' + safe + '</pre></body></html>';
    const w = window.open('about:blank','_blank');
    w.document.open(); w.document.write(html); w.document.close();
  });

  // Download template (SAFE: no injected script tags in the generated file)
  q('downloadTpl').addEventListener('click', ()=> {
    render();
    const content = q('slipContent').textContent || '';
    const safe = content.replaceAll('&','&amp;').replaceAll('<','&lt;');
    const html = '<!doctype html><html><head><meta charset="utf-8"><title>slip-template</title><style>body{font-family:"Courier New",monospace;white-space:pre;padding:12px}</style></head><body><pre>' + safe + '</pre></body></html>';
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'slip-template.html'; a.click(); URL.revokeObjectURL(url);
  });

  // Create PDF (10in x 4in)
  q('createPdfBtn').addEventListener('click', async ()=> {
    try{
      render();
      const inner = q('slipInner');
      inner.style.width = '10in'; inner.style.height = '4in';
      await new Promise(r=>setTimeout(r,60));
      const canvas = await html2canvas(inner, {scale:2, useCORS:true, backgroundColor:'#ffffff'});
      const img = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const widthMM = 10 * 25.4; const heightMM = 4 * 25.4;
      const pdf = new jsPDF({unit:'mm', format:[widthMM, heightMM], orientation:'landscape'});
      pdf.addImage(img, 'PNG', 0, 0, widthMM, heightMM);
      const blob = pdf.output('blob'); const url = URL.createObjectURL(blob); window.open(url, '_blank');
    }catch(err){
      console.error('PDF error', err);
      alert('PDF creation failed — check console for details');
    }
  });

  // initial render
  render();
})();
</script>

</body>
</html>
