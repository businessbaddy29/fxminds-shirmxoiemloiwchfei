<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Slip — Create Slip (Final)</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:transparent;color:#0d2433}
    body::before{content:"";position:fixed;inset:0;z-index:-3;background-image:url("truck.avif");background-size:cover;background-position:center;filter:blur(6px) brightness(.95)}
    body::after{content:"";position:fixed;inset:0;z-index:-2;background:linear-gradient(rgba(255,255,255,0.66),rgba(255,255,255,0.66))}
    .container{max-width:1100px;margin:22px auto;padding-bottom:60px}
    .card{background:linear-gradient(180deg,#fff,#fbfdff);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(22,40,60,0.06);border:1px solid rgba(10,18,30,0.04);margin-bottom:18px}
    .loginBox h2{margin:0 0 12px 0;color:#0b2330;font-size:20px}
    .loginBox input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid rgba(20,30,40,0.06);font-family:"Courier New",monospace}
    .loginBox button{width:100%;padding:10px;border-radius:8px;border:none;background:#0b63b3;color:#fff;font-weight:600;cursor:pointer}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
    label{display:block;color:#0b2330;font-size:14px;margin-top:8px}
    input[type="text"],input[type="date"],input[type="number"],select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(20,30,40,.06);font-family:"Courier New",monospace;box-sizing:border-box}
    .time-row{display:flex;gap:8px}
    .time-row>div{flex:1}
    .controls{display:flex;gap:8px;margin-top:10px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-blue{background:linear-gradient(180deg,#1976d2,#0b63b3);color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(10,18,30,0.06);color:#07304b}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{padding:8px 6px;text-align:left;border-bottom:1px solid rgba(10,18,30,0.04);font-size:13px;vertical-align:middle}
    .table th{color:#07304b;font-weight:700}
    .amount-input{width:100px;padding:6px;font-family:monospace}
    .err{border-color:#d33 !important;box-shadow:0 0 0 3px rgba(211,51,51,0.08)}
    .errMsg{color:#d33;font-weight:700;margin-top:6px;font-size:13px}
    #serverError{margin-top:10px;color:#b33;font-weight:700;display:none}

    /* ===== Preview overlay (NO SCROLL) ===== */
    #slipOutput{
      display:none;
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      width:min(1200px,94%);
      max-width:1200px;
      max-height:94vh;
      z-index:9999;
      border-radius:8px;
      box-shadow:0 30px 80px rgba(0,0,0,0.35);
      background:transparent;
      overflow:visible;
    }
    #previewToolbar{display:flex;gap:8px;padding:8px;justify-content:flex-end;background:rgba(12,20,30,0.03);border-top-left-radius:8px;border-top-right-radius:8px}
    /* slipInner: fixed viewport that NEVER scrolls; content inside is absolutely centered and scaled */
    #slipInner{
      background:#fff;
      padding:18px;
      border-bottom-left-radius:8px;
      border-bottom-right-radius:8px;
      color:#000;
      font-family:"Courier New",monospace;
      box-sizing:border-box;
      position:relative;
      width:100%;
      height:calc(94vh - 56px);
      overflow:hidden;
      display:block;
    }
    /* slipContent will be absolutely positioned and transformed to center */
    #slipContent{ position:absolute; left:50%; top:50%; transform-origin: center center; white-space:normal; }
    @media print{
      body *{visibility:hidden!important}
      #slipOutput,#slipOutput *{visibility:visible!important}
      #slipOutput{position:absolute!important;left:0!important;top:0!important;width:100%!important;margin:0!important;padding:10mm!important;background:#fff!important;box-shadow:none!important;overflow:visible!important}
      #previewToolbar{display:none!important}
      /* For printing show natural 10in width (no transform) */
      #slipContent{position:static!important;transform:none!important;width:10in!important;margin:0!important}
      #slipInner{overflow:visible!important;height:auto!important}
    }

    .slip-wrapper{white-space:pre;font-family:"Courier New",monospace;color:#000}
    .filters-row { display:flex; gap:8px; align-items:center; }
    .filters-row input[type="text"] { width:160px; }
    .meta-right { text-align:right; font-weight:700; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div class="card loginBox" id="loginBox">
      <h2>Login</h2>
      <input id="username" placeholder="User ID" autocomplete="off" />
      <input id="password" placeholder="Password" type="password" autocomplete="off" />
      <button id="loginBtn" class="btn btn-blue">Login</button>
      <p id="loginErr" style="color:#d33; display:none; margin-top:8px;">Invalid credentials</p>
    </div>

    <!-- FORM -->
    <div class="card" id="formCard" style="display:none;">
      <form id="slipForm" onsubmit="return false;">
        <label>Firm Name: <input type="text" id="firmName" value="FIRM NAME" required></label>
        <div id="firmNameErr" class="errMsg" style="display:none">भाई इसे कोन भरेगा</div>
        <label>Firm Address: <input type="text" id="firmAddress" value="FIRM ADDRESS" required></label>
        <label>Firm Phone: <input type="text" id="firmPhone" placeholder="Enter firm phone (optional)"></label>
        <div id="firmAddressErr" class="errMsg" style="display:none">भाई इसे कोन भरेगा</div>

        <div class="form-grid">
          <label>RST No: <input type="text" id="rstNo" value="101" required></label>
          <label>Vehicle No: <input type="text" id="vehicleNo" value="RJ32GE0903" required></label>
        </div>

        <div class="form-grid">
          <label>Item: <input type="text" id="item" value="20MM" required></label>
          <label>Vehicle Type: <input type="text" id="vehicleType"></label>
          <label>Party Name: <input type="text" id="partyName" placeholder="Enter Party Name (optional)"></label>
          <label>Address: <input type="text" id="address" placeholder="Enter Address (optional)"></label>
        </div>

        <div class="form-grid">
          <label>Gross (weight): <input type="text" id="gross" value="70680 Kg" readonly></label>
          <label>Gross Date: <input type="text" id="grossDate" value="2025/11/08"></label>
        </div>

        <div class="time-row" style="margin-top:6px;">
          <div style="flex:1">
            <label>Gross Time (enter exactly): <input type="text" id="grossTime" placeholder="e.g. 13:37"></label>
          </div>
          <div style="flex:1">
            <label>Tare Time (enter exactly): <input type="text" id="tareTime" placeholder="e.g. 13:45"></label>
          </div>
        </div>

        <div class="form-grid">
          <label>Tare (weight): <input type="text" id="tare" value="15700 Kg"></label>
          <label>Tare Date: <input type="text" id="tareDate" value="2025-11-08"></label>
        </div>

        <label>Net: <input type="text" id="net" value="54980 Kg"></label>
        <label>Charges: Rs <input type="text" id="charges" value="0"></label>
        <label>Phone: <input type="text" id="phone" value="123456"></label>

        <div class="controls">
          <button type="button" id="createBtn" class="btn btn-blue">Create Slip</button>
          <button type="button" id="logoutBtn" class="btn btn-ghost" style="margin-left:auto">Logout</button>
        </div>
        <div id="serverError"></div>
      </form>
    </div>

    <!-- SAVED SLIPS -->
    <div class="card" id="dashboardCard" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div>
          <div style="font-size:18px; font-weight:700; color:#072033">Saved Slips</div>
          <div style="font-size:13px; color:#235">Server-stored slips (data only)</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; width:620px; justify-content:flex-end;">
          <div class="filters-row" style="align-items:center;">
            <label style="font-size:13px; color:#07304b; margin-right:6px;">From</label>
            <input type="date" id="filterFrom">
            <label style="font-size:13px; color:#07304b; margin-left:8px; margin-right:6px;">To</label>
            <input type="date" id="filterTo">
            <label style="font-size:13px; color:#07304b; margin-left:8px; margin-right:6px;">Vehicle</label>
            <input type="text" id="filterVehicle" placeholder="Vehicle No">
            <button id="applyFilter" class="btn btn-ghost">Apply</button>
          </div>
          <div style="margin-left:12px; text-align:right;">
            <div style="font-weight:700">Total Amount: <span id="totalAmount">0</span></div>
            <div style="font-size:12px; color:#666">Count: <span id="totalCount">0</span></div>
          </div>
        </div>
      </div>
      <div id="recordsWrap" style="margin-top:12px;">
        <table class="table" id="recordsTable" aria-live="polite">
          <thead>
            <tr>
              <th>Sr</th>
              <th>Date</th>
              <th>Vehicle</th>
              <th>Saved PDF</th>
              <th>Amount (₹)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Slip preview overlay -->
  <div id="slipOutput" role="dialog" aria-modal="true">
    <div id="previewToolbar">
      <button id="printPreviewBtn" class="btn btn-blue">Print</button>
      <button id="closePreviewBtn" class="btn btn-ghost">Close</button>
    </div>
    <div id="slipInner">
      <div id="slipContent" style="color:#000"></div>
    </div>
  </div>

<script>
/* ---------- TEMPLATE (kept monospace + ascii lines) ---------- */
const TEMPLATE_HTML = `
<div style='font-family: "SF Mono", monospace; color:#333; width:8in; box-sizing:border-box; padding:8px;'>
  <div style="text-align:center; width:100%; margin-bottom:10px;">
      <div style="letter-spacing:2px; font-size:40px; font-weight:;">
          {{firmName}}
      </div>
      <div style="font-size:20px;">
          {{firmAddress}}
      </div>
      <div style="font-size:20px;">
          {{firmPhone}}
      </div>
  </div>
  <pre class="details" style='margin:0; padding:6px; white-space:pre; font-family: "SF Mono", monospace; line-height:1; font-size:18px;'>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

<span style="font-size:20px;">RST No.     : {{rstNo}}</span>                                   <span style="font-size:20px;">Vehicle No.      : {{vehicleNo}}</span>
<span style="font-size:20px;">Vh l typ.   : {{vehicleType}}</span>                                      <span style="font-size:20px;"> Party name      : {{partyName}}</span>
<span style="font-size:20px;">Address     : {{address}}</span>                                      <span style="font-size:20px;"> Item            : {{item}}</span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

<span style="font-size:20px;">Gross   :</span>      <span style="font-size:35px; font-weight:    ;">{{gross}}</span><span style="font-size:20px;">         Date  : {{grossDate}}</span>    <span style="font-size:20px;">   Time     :    {{grossTime}}</span>
<span style="font-size:20px;">Tare    :</span>      <span style="font-size:35px; font-weight:    ;">{{tare}}</span><span style="font-size:20px;">         Date  : {{tareDate}}</span>       <span style="font-size:20px;">Time     :    {{tareTime}}</span>
<span style="font-size:20px;">Net     :</span>      <span style="font-size:35px; font-weight:    ;">{{net}}</span>  <span style="font-size:20px;">  </span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

<span style="font-size:20px;">Charges : Rs {{charges}}</span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

                                            <span style="font-size:20px;">Phone : {{phone}}</span>

                                         <span style="font-size:20px;">Thanks for your visit</span>
  </pre>
</div>
`;

/* endpoints & settings */
const SERVER_BASE = (function(){ try { return window.location.origin + '/slip-server'; } catch(e) { return '/slip-server'; }})();
const CREATE_ENDPOINT = SERVER_BASE + '/create_csv.php';
const LIST_ENDPOINT   = SERVER_BASE + '/get_slips.php';
const AMOUNT_ENDPOINT = SERVER_BASE + '/update_amount.php';

const USERNAME = "FxMiNds";
const PASSWORD = "Sk@#9136332836@";
let isLoggedIn = false;
window._slips = [];

const recordsBody = document.getElementById('recordsBody');
const totalAmountEl = document.getElementById('totalAmount');
const totalCountEl = document.getElementById('totalCount');
const slipOutput = document.getElementById('slipOutput');
const slipInner = document.getElementById('slipInner');
const slipContent = document.getElementById('slipContent');
const printPreviewBtn = document.getElementById('printPreviewBtn');
const closePreviewBtn = document.getElementById('closePreviewBtn');

/* helpers */
function getVal(id){ const el=document.getElementById(id); return el?el.value:''; }
function esc(str){ const map={ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }; return String(str).replace(/[&<>"']/g,m=>map[m]); }

/* robust parse for pasted weights */
function parseWeight(v){
  if (v === null || v === undefined) return 0;
  let s = String(v).trim();
  if (s === '') return 0;
  // remove 'Kg' or variations and commas/spaces
  s = s.replace(/Kg/i, '').replace(/kg/i,'').replace(/,/g,'').trim();
  // sometimes user pastes like " 15 700 " -> remove extra spaces
  s = s.replace(/\s+/g,'');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}
function formatWeightForDisplay(v){
  // v may be a string like "15700 Kg" or number. Return: "15700 Kg" (no leading zeros)
  if (v === null || v === undefined) return '0 Kg';
  // if value already includes 'Kg' and number is present, normalize
  const n = parseWeight(v);
  return `${Number(n).toFixed(0)} Kg`;
}

/* -------------------
   ZERO NORMALIZATION
   ------------------- */
function normalizeToAsciiZero(s){
  if(s === null || s === undefined) return '';
  let t = String(s);
  t = t.replace(/0\//g, '0');
  t = t.replace(/[\u00D8\u00F8]/g, '0');
  t = t.replace(/0[\u0337\u0338\u0335\u0336\u033F]+/g, '0');
  t = t.replace(/[\u0337\u0338\u0335\u0336\u033F]+/g, '');
  t = t.replace(/[\u1D7CE\u1D7D8\u1D7E2\u1D7F6]/g, '0');
  return t;
}
function normalizeRecordZeros(rec){
  const out = Object.assign({}, rec);
  // keep 'item' untouched (text)
  ['gross','tare','net','charges','phone','rstNo','vehicleNo','firmPhone'].forEach(k=>{
    if(out[k] !== undefined && out[k] !== null) out[k] = normalizeToAsciiZero(String(out[k]));
  });
  return out;
}

/* local slips helpers (unchanged) */
function generateSerial(){ try{ const k='slip_serial_counter_v1'; let v=Number(localStorage.getItem(k)||'0'); v=v+1; localStorage.setItem(k,String(v)); return String(v).padStart(13,'0'); }catch(e){ return String(Date.now()); } }
function persistLocalSlips(){ try{ localStorage.setItem('client_slips_v1', JSON.stringify(window._slips||[])); }catch(e){} }
function loadLocalSlips(){ try{ const r=localStorage.getItem('client_slips_v1'); window._slips = r?JSON.parse(r):[]; }catch(e){ window._slips = []; } }
function addLocalSlipRecord(rec){ try{ if(!Array.isArray(window._slips)) window._slips=[]; const id=generateSerial(); const createdAt=new Date().toISOString(); window._slips.unshift({id,createdAt,vehicleNo:rec.vehicleNo||'',filename:null,amount:''}); persistLocalSlips(); renderSlipsTable(window._slips); }catch(e){console.error(e);} }

/* ---------- RENDER (fixed weights & formatting) ---------- */
function renderSlipToDom(data){
  // Normalize numeric-like fields but keep 'item' exactly as user entered
  const safe = normalizeRecordZeros(data || {});

  // compute display values for weights robustly
  const displayedTare = formatWeightForDisplay(data && data.tare ? data.tare : safe.tare);
  const displayedNet  = formatWeightForDisplay(data && data.net ? data.net : safe.net);
  // prefer gross from form if set, otherwise compute from tare+net
  let displayedGross = '';
  if (data && data.gross && String(data.gross).trim() !== '') {
    displayedGross = formatWeightForDisplay(data.gross);
  } else {
    // compute from parsed numbers
    const gnum = parseWeight(displayedTare) + parseWeight(displayedNet);
    displayedGross = `${Number(gnum).toFixed(0)} Kg`;
  }

  const replacements = {
    '{{firmName}}': esc((data && data.firmName) || safe.firmName || ''),
    '{{firmAddress}}': esc((data && data.firmAddress) || safe.firmAddress || ''),
    '{{firmPhone}}': esc((data && data.firmPhone) || safe.firmPhone || ''),
    '{{rstNo}}': esc((data && data.rstNo) || safe.rstNo || ''),
    '{{vehicleNo}}': esc((data && data.vehicleNo) || safe.vehicleNo || ''),
    '{{vehicleType}}': esc((data && data.vehicleType) || safe.vehicleType || ''),
    '{{partyName}}': esc((data && data.partyName) || safe.partyName || ''),
    '{{address}}': esc((data && data.address) || safe.address || ''),
    '{{item}}': esc((data && data.item) || (safe.item || '')),
    '{{gross}}': esc(displayedGross),
    '{{grossDate}}': esc((data && data.grossDate) || safe.grossDate || ''),
    '{{grossTime}}': esc((data && data.grossTime) || safe.grossTime || ''),
    '{{tare}}': esc(displayedTare),
    '{{tareDate}}': esc((data && data.tareDate) || safe.tareDate || ''),
    '{{tareTime}}': esc((data && data.tareTime) || safe.tareTime || ''),
    '{{net}}': esc(displayedNet),
    '{{amount}}': esc((data && data.amount) || (safe.amount || '')),
    '{{charges}}': esc((data && data.charges) || (safe.charges || '0')),
    '{{phone}}': esc((data && data.phone) || (safe.phone || ''))
  };

  let rendered = TEMPLATE_HTML;
  Object.keys(replacements).forEach(k => { rendered = rendered.split(k).join(replacements[k]); });
  slipContent.innerHTML = rendered;
}

/* fit preview (unchanged) */
function fitSlipPreview() {
  requestAnimationFrame(() => {
    const slipDom = slipContent.firstElementChild;
    if (!slipDom) return;
    slipDom.style.boxSizing = 'border-box';
    slipDom.style.width = '10in';
    const naturalW = slipDom.offsetWidth || (96 * 10);
    const naturalH = slipDom.offsetHeight || 800;
    const parentRect = slipInner.getBoundingClientRect();
    const availableW = Math.max(100, parentRect.width - 36);
    const availableH = Math.max(100, parentRect.height - 36);
    const scaleW = availableW / naturalW;
    const scaleH = availableH / naturalH;
    let scale = Math.min(scaleW, scaleH, 1);
    if (scale > 1) scale = 1;
    if (scale < 0.35) scale = 0.35;
    slipContent.style.position = 'absolute';
    slipContent.style.left = '50%';
    slipContent.style.top = '50%';
    slipContent.style.transformOrigin = 'center center';
    slipContent.style.transform = `translate(-50%,-50%) scale(${scale})`;
    slipContent.style.width = `${naturalW}px`;
    slipContent.style.height = `${naturalH}px`;
  });
}

/* observers & resize (unchanged) */
let resizeTimer = null;
window.addEventListener('resize', ()=>{ if(resizeTimer) clearTimeout(resizeTimer); resizeTimer = setTimeout(()=>{ fitSlipPreview(); resizeTimer=null; }, 80); });
const mo = new MutationObserver(()=> fitSlipPreview());
mo.observe(document.body, { childList:true, subtree:true });

/* validation (unchanged) */
function validateAll(){
  const req = ['firmName','firmAddress','rstNo','vehicleNo','item'];
  let ok=true;
  req.forEach(id=>{ const el=document.getElementById(id); if(!el || String(el.value||'').trim()===''){ ok=false; if(el) el.classList.add('err'); } else if(el) el.classList.remove('err'); });
  return ok;
}

function handleCreateClick() {
  if(!isLoggedIn){ alert('Please login first'); return; }
  if(!validateAll()){ alert('Please fill required fields'); return; }
  const rec = collectForm();
  const normalizedRec = normalizeRecordZeros(rec);
  addLocalSlipRecord(normalizedRec);
  renderSlipToDom(normalizedRec);
  slipOutput.style.display = 'block';
  setTimeout(()=> fitSlipPreview(), 80);
}

/* print & close (unchanged) */
printPreviewBtn && printPreviewBtn.addEventListener('click', ()=>{ setTimeout(()=> window.print(), 60); });
closePreviewBtn && closePreviewBtn.addEventListener('click', ()=>{ slipOutput.style.display='none'; });

/* remaining code unchanged (list, amount etc.) */
async function refreshList() {
  try {
    const from = getVal('filterFrom') || '';
    const to = getVal('filterTo') || '';
    const vehicle = (getVal('filterVehicle') || '').trim();
    const q = new URLSearchParams({ from, to });
    if (vehicle) q.set('vehicle', vehicle);
    const resp = await fetch(LIST_ENDPOINT + '?' + q.toString(), { cache: 'no-store' });
    const json = await resp.json().catch(() => null);
    let slips = [];
    if (json && Array.isArray(json.slips)) {
      slips = json.slips.map(s => normalizeRecordZeros(s));
    } else {
      loadLocalSlips();
      slips = (window._slips || []).slice();
    }
    renderSlipsTable(slips);
  } catch (err) {
    console.error('refreshList', err);
    loadLocalSlips();
    renderSlipsTable(window._slips || []);
  }
}

function renderSlipsTable(slips) {
  recordsBody.innerHTML = '';
  let totalAmt = 0;
  slips.forEach(s=>{
    const safeId = String(s.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="width:60px">${safeId}</td>
      <td style="width:180px">${(new Date(s.createdAt)).toLocaleString()}</td>
      <td style="width:140px">${s.vehicleNo || '-'}</td>
      <td style="width:120px">${s.filename ? 'Saved' : '-'}</td>
      <td style="width:150px" id="amountCell_${safeId}">
        ${s.amount !== undefined && s.amount !== null && s.amount !== '' ?
          `<span>₹ ${Number(s.amount).toFixed(2)}</span>` :
          `<input type="number" step="0.01" min="0" id="amt_in_${safeId}" class="amount-input" placeholder="0.00">
           <button class="btn btn-blue amount-submit" id="amt_btn_${safeId}" data-id="${safeId}">Submit</button>`
        }
      </td>
      <td style="width:160px">
        <span style="color:#666">—</span>
      </td>
    `;
    recordsBody.appendChild(tr);
    totalAmt += Number(s.amount || 0);
  });
  totalAmountEl.textContent = totalAmt.toFixed(2);
  totalCountEl.textContent = (slips || []).length;
  window._slips = slips;
  // attach amount buttons
  (window._slips || []).forEach(s => {
    const safeId = String(s.id);
    const btn = document.getElementById(`amt_btn_${safeId}`);
    if (btn) {
      btn.addEventListener('click', async (ev) => {
        const id = ev.currentTarget.dataset.id;
        const input = document.getElementById(`amt_in_${id}`);
        const val = input ? input.value : '';
        const norm = String(val || '').replace(/,/g,'').trim();
        if (norm === '' || isNaN(Number(norm))) {
          alert('Enter valid amount');
          return;
        }
        try {
          let serverWorked = false;
          try {
            const resp = await fetch(AMOUNT_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, amount: Number(norm) }),
              keepalive: true
            });
            if (resp && resp.ok) {
              const j = await resp.json().catch(()=>null);
              if (j && j.ok) serverWorked = true;
            }
          } catch(e) {}
          if (serverWorked) { alert('Amount saved (server).'); await refreshList(); return; }
          let updated = false;
          for (let i=0;i<window._slips.length;i++){
            if (String(window._slips[i].id) === String(id)) {
              window._slips[i].amount = Number(norm).toFixed(2);
              updated = true;
              break;
            }
          }
          if (!updated) { loadLocalSlips(); for (let i=0;i<window._slips.length;i++){ if (String(window._slips[i].id) === String(id)) { window._slips[i].amount = Number(norm).toFixed(2); updated = true; break; } } }
          persistLocalSlips();
          renderSlipsTable(window._slips);
          alert('Amount saved locally (server not reachable).');
        } catch (err) { console.error('Amount submit error', err); alert('Error saving amount.'); }
      });
    }
  });
}

document.getElementById('applyFilter').addEventListener('click', () => refreshList());

/* collect form */
function collectForm(){
  // read raw inputs and preserve values (weights formatted via formatWeightForDisplay)
  const tareVal = getVal('tare') || '';
  const netVal = getVal('net') || '';
  const grossVal = (getVal('gross') && String(getVal('gross')).trim() !== '') ? getVal('gross') : `${parseWeight(tareVal) + parseWeight(netVal)} Kg`;
  return {
    firmName: getVal('firmName'),
    firmAddress: getVal('firmAddress'),
    firmPhone: getVal('firmPhone'),
    rstNo: getVal('rstNo'),
    vehicleNo: getVal('vehicleNo'),
    vehicleType: getVal('vehicleType'),
    partyName: getVal('partyName'),
    address: getVal('address'),
    item: getVal('item'),
    gross: formatWeightForDisplay(grossVal),
    grossDate: getVal('grossDate') || new Date().toISOString().slice(0,10),
    grossTime: getVal('grossTime'),
    tare: formatWeightForDisplay(tareVal),
    tareDate: getVal('tareDate') || new Date().toISOString().slice(0,10),
    tareTime: getVal('tareTime'),
    net: formatWeightForDisplay(netVal),
    charges: (getVal('charges')||'0'),
    phone: getVal('phone'),
    savedAt: new Date().toISOString()
  };
}

/* Login + bindings */
document.addEventListener('DOMContentLoaded', () => {
  try {
    const loginBtnEl = document.getElementById('loginBtn');
    const logoutBtnEl = document.getElementById('logoutBtn');
    const loginBoxEl = document.getElementById('loginBox');
    const formCardEl = document.getElementById('formCard');
    const dashboardCardEl = document.getElementById('dashboardCard');
    const createBtnEl = document.getElementById('createBtn');

    function setLoggedIn(flag) {
      isLoggedIn = !!flag;
      try { localStorage.setItem('slip_isLoggedIn', isLoggedIn ? '1' : '0'); } catch(e){}
      if (isLoggedIn) { loginBoxEl.style.display = 'none'; formCardEl.style.display = 'block'; dashboardCardEl.style.display = 'block'; try { refreshList(); } catch(e){} }
      else { loginBoxEl.style.display = 'block'; formCardEl.style.display = 'none'; dashboardCardEl.style.display = 'none'; }
    }

    loginBtnEl.addEventListener('click', () => {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      if (u === USERNAME && p === PASSWORD) setLoggedIn(true);
      else { const loginErr = document.getElementById('loginErr'); if (loginErr) { loginErr.style.display = 'block'; setTimeout(()=>loginErr.style.display='none',2000); } else alert('Invalid credentials'); }
    });

    logoutBtnEl.addEventListener('click', () => { setLoggedIn(false); try{ localStorage.removeItem('slip_isLoggedIn'); }catch(e){} });

    try { const v = localStorage.getItem('slip_isLoggedIn'); if (v === '1') setLoggedIn(true); else setLoggedIn(false); } catch(e) { setLoggedIn(false); }

    createBtnEl.addEventListener('click', handleCreateClick);

    // normalization list (item intentionally NOT in list)
    const ZERO_NORMALIZE_FIELDS = ['gross','tare','net','charges','phone','rstNo','vehicleNo','firmPhone'];
    ZERO_NORMALIZE_FIELDS.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('blur', ()=> { el.value = normalizeToAsciiZero(el.value || ''); });
      el.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter'){ setTimeout(()=> el.value = normalizeToAsciiZero(el.value || ''), 0); } });
    });

    // Live recompute gross when tare or net change
    const tareEl = document.getElementById('tare');
    const netEl = document.getElementById('net');
    const grossEl = document.getElementById('gross');
    function recomputeGrossField() {
      try {
        const t = parseWeight(tareEl ? tareEl.value : '');
        const n = parseWeight(netEl ? netEl.value : '');
        const g = Number(t) + Number(n);
        if (grossEl) grossEl.value = `${Number(g).toFixed(0)} Kg`;
      } catch(e) { console.warn(e); }
    }
    if (tareEl) { tareEl.addEventListener('input', recomputeGrossField); tareEl.addEventListener('blur', ()=>{ tareEl.value = formatWeightForDisplay(tareEl.value || ''); recomputeGrossField(); }); }
    if (netEl) { netEl.addEventListener('input', recomputeGrossField); netEl.addEventListener('blur', ()=>{ netEl.value = formatWeightForDisplay(netEl.value || ''); recomputeGrossField(); }); }
    // initialize gross correctly on load
    try { recomputeGrossField(); } catch(e){}
  } catch(e) { console.error('DOMContentLoaded error', e); }
});

/* initial load */
refreshList();
</script>
</body>
</html>
