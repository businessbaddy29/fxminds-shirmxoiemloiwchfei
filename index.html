<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Secure Slip — Create Slip (Final Fit v3)</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:transparent;color:#0d2433}
    body::before{content:"";position:fixed;inset:0;z-index:-3;background-image:url("truck.avif");background-size:cover;background-position:center;filter:blur(6px) brightness(.95)}
    body::after{content:"";position:fixed;inset:0;z-index:-2;background:linear-gradient(rgba(255,255,255,0.66),rgba(255,255,255,0.66))}
    .container{max-width:1100px;margin:22px auto;padding-bottom:60px}
    .card{background:linear-gradient(180deg,#fff,#fbfdff);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(22,40,60,0.06);border:1px solid rgba(10,18,30,0.04);margin-bottom:18px}
    label{display:block;color:#0b2330;font-size:14px;margin-top:8px}
    input[type="text"],input[type="date"],input[type="number"],select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(20,30,40,.06);font-family:"Courier New",monospace;box-sizing:border-box}
    .controls{display:flex;gap:8px;margin-top:10px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-blue{background:linear-gradient(180deg,#1976d2,#0b63b3);color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(10,18,30,0.06);color:#07304b}

    /* Preview overlay: center + scale fit (no scroll) */
    #slipOutput{
      display:none;
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      width:min(1100px,94%);
      max-width:1100px;
      max-height:94vh;
      z-index:9999;
      border-radius:8px;
      box-shadow:0 30px 80px rgba(0,0,0,0.35);
      background:transparent;
      overflow:visible;
    }
    #previewToolbar{display:flex;gap:8px;padding:8px;justify-content:flex-end;background:rgba(12,20,30,0.03);border-top-left-radius:8px;border-top-right-radius:8px}
    #slipInner{
      background:#fff;
      padding:12px;
      border-bottom-left-radius:8px;
      border-bottom-right-radius:8px;
      color:#000;
      font-family:"Courier New",monospace;
      box-sizing:border-box;
      position:relative;
      width:100%;
      height:calc(94vh - 56px);
      overflow:hidden; /* hide scrollbar */
    }
    /* slipContent is absolute and will be centered and scaled */
    #slipContent{ position:absolute; left:50%; top:50%; transform-origin:center center; }

    @media print{
      body *{visibility:hidden!important}
      #slipOutput,#slipOutput *{visibility:visible!important}
      #slipOutput{position:absolute!important;left:0!important;top:0!important;width:100%!important;margin:0!important;padding:10mm!important;background:#fff!important;box-shadow:none!important;overflow:visible!important}
      #previewToolbar{display:none!important}
      /* print natural width set to 8.5in for better fit on many printers */
      #slipContent{position:static!important;transform:none!important;width:8.5in!important;margin:0!important}
      #slipInner{overflow:visible!important;height:auto!important}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div class="card loginBox" id="loginBox">
      <h2>Login</h2>
      <input id="username" placeholder="User ID" autocomplete="off" />
      <input id="password" placeholder="Password" type="password" autocomplete="off" />
      <button id="loginBtn" class="btn btn-blue">Login</button>
      <p id="loginErr" style="color:#d33; display:none; margin-top:8px;">Invalid credentials</p>
    </div>

    <!-- FORM (unchanged) -->
    <div class="card" id="formCard" style="display:none;">
      <form id="slipForm" onsubmit="return false;">
        <label>Firm Name: <input type="text" id="firmName" value="FIRM NAME" required></label>
        <label>Firm Address: <input type="text" id="firmAddress" value="FIRM ADDRESS" required></label>
        <label>Firm Phone: <input type="text" id="firmPhone" placeholder="Enter firm phone (optional)"></label>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <label>RST No: <input type="text" id="rstNo" value="101" required></label>
          <label>Vehicle No: <input type="text" id="vehicleNo" value="RJ32GE0903" required></label>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <label>Item: <input type="text" id="item" value="20MM" required></label>
          <label>Vehicle Type: <input type="text" id="vehicleType"></label>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <label>Gross (weight): <input type="text" id="gross" value="70680 Kg"></label>
          <label>Gross Date: <input type="text" id="grossDate" value="2025/11/08"></label>
        </div>

        <div style="display:flex;gap:8px;margin-top:6px">
          <div style="flex:1"><label>Gross Time: <input type="text" id="grossTime" placeholder="e.g. 13:37"></label></div>
          <div style="flex:1"><label>Tare Time: <input type="text" id="tareTime" placeholder="e.g. 13:45"></label></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <label>Tare (weight): <input type="text" id="tare" value="15700 Kg"></label>
          <label>Tare Date: <input type="text" id="tareDate" value="2025-11-08"></label>
        </div>

        <label>Net: <input type="text" id="net" value="54980 Kg"></label>
        <label>Charges: Rs <input type="text" id="charges" value="0"></label>
        <label>Phone: <input type="text" id="phone" value="123456"></label>

        <div class="controls">
          <button type="button" id="createBtn" class="btn btn-blue">Create Slip</button>
          <button type="button" id="logoutBtn" class="btn btn-ghost" style="margin-left:auto">Logout</button>
        </div>
        <div id="serverError"></div>
      </form>
    </div>

    <!-- Saved list (unchanged) -->
    <div class="card" id="dashboardCard" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div style="font-size:18px;font-weight:700;color:#072033">Saved Slips</div>
          <div style="font-size:13px;color:#235">Server-stored slips (data only)</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:13px;color:#07304b;">From</label>
          <input type="date" id="filterFrom">
          <label style="font-size:13px;color:#07304b;">To</label>
          <input type="date" id="filterTo">
          <button id="applyFilter" class="btn btn-ghost">Apply</button>
          <div style="font-weight:700">Total Amount: <span id="totalAmount">0</span></div>
        </div>
      </div>

      <div id="recordsWrap" style="margin-top:12px">
        <table class="table" id="recordsTable" aria-live="polite">
          <thead>
            <tr><th>Sr</th><th>Date</th><th>Vehicle</th><th>Saved PDF</th><th>Amount (₹)</th><th>Action</th></tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Preview overlay -->
  <div id="slipOutput" role="dialog" aria-modal="true">
    <div id="previewToolbar">
      <button id="printPreviewBtn" class="btn btn-blue">Print</button>
      <button id="closePreviewBtn" class="btn btn-ghost">Close</button>
    </div>
    <div id="slipInner">
      <div id="slipContent" style="color:#000"></div>
    </div>
  </div>

<script>
/* TEMPLATE: note natural width = 8.5in for better fit on preview/printer; font sizes slightly reduced */
const TEMPLATE_HTML = `
<div style='font-family:"Courier New",monospace;color:#000;width:8.5in;box-sizing:border-box;padding:6px;'>
  <pre style='margin:0;padding:6px;white-space:pre;line-height:1.12;font-size:20px;'>
                <span style="letter-spacing:2px;font-size:52px">{{firmName}}</span>
                            <span style="font-size:30px">{{firmAddress}}</span>
                                 <span style="font-size:30px">{{firmPhone}}</span>

_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
<span style="font-size:30px">RST No.     : {{rstNo}}</span>                                   <span style="font-size:30px">Vehicle No.     : {{vehicleNo}}</span>
<span style="font-size:30px">Vh l typ.   : {{vehicleType}}</span>                                      <span style="font-size:30px"> Party name      : {{partyName}}</span>
<span style="font-size:30px">Address     : {{address}}</span>                                      <span style="font-size:30px"> Item            : {{item}}</span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

<span style="font-size:30px">Gross   :</span>      <span style="font-size:42px">{{gross}}</span><span style="font-size:30px"> Kg      Date  : {{grossDate}}</span>    <span style="font-size:30px">  Time     :    {{grossTime}}</span>
<span style="font-size:30px">Tare    :</span>      <span style="font-size:42px">{{tare}}</span><span style="font-size:30px"> Kg      Date  : {{tareDate}}</span>       <span style="font-size:30px">Time     :    {{tareTime}}</span>
<span style="font-size:30px">Net     :</span>      <span style="font-size:42px">{{net}}</span>  <span style="font-size:30px">Kg</span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<span style="font-size:30px">Charges : Rs {{charges}}</span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

                                            <span style="font-size:30px">Phone : {{phone}}</span>

                                         <span style="font-size:30px">Thanks for your visit</span>
  </pre>
</div>
`;

/* Configs (unchanged) */
const SERVER_BASE = '/slip-server';
function buildServerUrl(path){ const base = SERVER_BASE || ''; if(base.startsWith('http://')||base.startsWith('https://')) return base+path; return window.location.origin + (base.startsWith('/') ? base : ('/'+base)) + path; }
const CREATE_ENDPOINT = buildServerUrl('/create_pdf.php');
const LIST_ENDPOINT   = buildServerUrl('/get_slips.php');
const AMOUNT_ENDPOINT = buildServerUrl('/update_amount.php');
const USERNAME = "FxMiNds";
const PASSWORD = "Sk@#9136332836@";
let isLoggedIn = false;

/* DOM refs */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginBox = document.getElementById('loginBox');
const formCard = document.getElementById('formCard');
const dashboardCard = document.getElementById('dashboardCard');
const createBtn = document.getElementById('createBtn');
const slipOutput = document.getElementById('slipOutput');
const slipInner = document.getElementById('slipInner');
const slipContent = document.getElementById('slipContent');
const printBtn = document.getElementById('printPreviewBtn');
const closeBtn = document.getElementById('closePreviewBtn');
const recordsBody = document.getElementById('recordsBody');
const totalAmountEl = document.getElementById('totalAmount');
const serverError = document.getElementById('serverError');

/* helpers */
function getVal(id){ const el=document.getElementById(id); return el?el.value:''; }
function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]||m)); }
function parseWeight(v){ return Number((v||'').toString().replace(/\s*Kg\s*/i,''))||0; }

/* login */
loginBtn.addEventListener('click', ()=>{ const u=getVal('username'), p=getVal('password'); if(u===USERNAME && p===PASSWORD){ setLoggedIn(true); } else { const e=document.getElementById('loginErr'); e.style.display='block'; setTimeout(()=>e.style.display='none',2000); }});
logoutBtn.addEventListener('click', ()=>{ setLoggedIn(false); try{ localStorage.removeItem('slip_isLoggedIn'); }catch(e){}});
function setLoggedIn(flag){ isLoggedIn=!!flag; try{ localStorage.setItem('slip_isLoggedIn', isLoggedIn?'1':'0'); }catch(e){} if(isLoggedIn){ loginBox.style.display='none'; formCard.style.display='block'; dashboardCard.style.display='block'; refreshList(); } else { loginBox.style.display='block'; formCard.style.display='none'; dashboardCard.style.display='none'; } }
window.addEventListener('load', ()=>{ try{ if(localStorage.getItem('slip_isLoggedIn')==='1'){ isLoggedIn=true; setLoggedIn(true); } }catch(e){} });

/* collect */
function collectForm(){
  const tareNum = parseWeight(getVal('tare')), netNum = parseWeight(getVal('net')), grossNum = tareNum + netNum;
  return {
    firmName: getVal('firmName'), firmAddress: getVal('firmAddress'), firmPhone: getVal('firmPhone'),
    rstNo: getVal('rstNo'), vehicleNo: getVal('vehicleNo'), vehicleType: getVal('vehicleType'),
    partyName: getVal('partyName'), address: getVal('address'), item: getVal('item'),
    gross: `${Number(grossNum).toFixed(0)} Kg`, grossDate: getVal('grossDate')||new Date().toISOString().slice(0,10), grossTime: getVal('grossTime'),
    tare: `${Number(tareNum).toFixed(0)} Kg`, tareDate: getVal('tareDate')||new Date().toISOString().slice(0,10), tareTime: getVal('tareTime'),
    net: `${Number(netNum).toFixed(0)} Kg`, charges: (getVal('charges')||'0'), phone: getVal('phone'), savedAt: new Date().toISOString()
  };
}

/* render */
function renderSlipToDom(data){
  const map = {
    '{{firmName}}': esc(data.firmName||''), '{{firmAddress}}':esc(data.firmAddress||''),'{{firmPhone}}':esc(data.firmPhone||''),
    '{{rstNo}}':esc(data.rstNo||''),'{{vehicleNo}}':esc(data.vehicleNo||''),'{{vehicleType}}':esc(data.vehicleType||''),
    '{{partyName}}':esc(data.partyName||''),'{{address}}':esc(data.address||''),'{{item}}':esc(data.item||''),
    '{{gross}}':esc(data.gross||''),'{{grossDate}}':esc(data.grossDate||''),'{{grossTime}}':esc(data.grossTime||''),
    '{{tare}}':esc(data.tare||''),'{{tareDate}}':esc(data.tareDate||''),'{{tareTime}}':esc(data.tareTime||''),
    '{{net}}':esc(data.net||''),'{{charges}}':esc(data.charges||''),'{{phone}}':esc(data.phone||'')
  };
  let r = TEMPLATE_HTML;
  Object.keys(map).forEach(k=> r = r.split(k).join(map[k]));
  slipContent.innerHTML = r;
}

/* fit preview: measure natural size (8.5in) and scale to fit both width & height */
function fitSlipPreview(){
  requestAnimationFrame(()=>{
    const slipDom = slipContent.firstElementChild;
    if(!slipDom) return;
    slipDom.style.boxSizing='border-box';
    slipDom.style.width='8.5in'; // natural print width used
    // allow painting
    const naturalW = slipDom.offsetWidth || (96*8.5);
    const naturalH = slipDom.offsetHeight || 700;
    const parent = slipInner.getBoundingClientRect();
    const availW = Math.max(120, parent.width - 16);
    const availH = Math.max(120, parent.height - 16);
    const scaleW = availW / naturalW;
    const scaleH = availH / naturalH;
    let scale = Math.min(scaleW, scaleH, 1);
    if(scale > 1) scale = 1;
    if(scale < 0.28) scale = 0.28; // avoid tiny
    slipContent.style.position='absolute';
    slipContent.style.left='50%';
    slipContent.style.top='50%';
    slipContent.style.transformOrigin='center center';
    slipContent.style.transform = `translate(-50%,-50%) scale(${scale})`;
    slipContent.style.width = naturalW + 'px';
    slipContent.style.height = naturalH + 'px';
  });
}

/* local slips simple storage */
function generateSerial(){ try{ const k='slip_serial_counter_v1'; let v=Number(localStorage.getItem(k)||'0'); v=v+1; localStorage.setItem(k,String(v)); return String(v).padStart(13,'0'); }catch(e){ return String(Date.now()); } }
function persistLocalSlips(){ try{ localStorage.setItem('client_slips_v1', JSON.stringify(window._slips||[])); }catch(e){} }
function loadLocalSlips(){ try{ const r=localStorage.getItem('client_slips_v1'); window._slips = r?JSON.parse(r):[]; }catch(e){ window._slips = []; } }
function addLocalSlipRecord(rec){ try{ window._slips = window._slips || []; const id = generateSerial(); const createdAt = new Date().toISOString(); window._slips.unshift({id,createdAt,vehicleNo:rec.vehicleNo||'',filename:null,amount:''}); persistLocalSlips(); renderSlipsTable(window._slips); }catch(e){console.error(e);} }

/* minimal validation */
function validateAll(){ const req=['firmName','firmAddress','rstNo','vehicleNo','item']; let ok=true; req.forEach(id=>{ const el=document.getElementById(id); if(!el||String(el.value||'').trim()===''){ ok=false; if(el) el.classList.add('err'); } else if(el) el.classList.remove('err'); }); return ok; }

/* create handler */
createBtn.addEventListener('click', async ()=>{
  if(!isLoggedIn){ alert('Please login first'); return; }
  if(!validateAll()){ alert('Please fill required fields'); return; }
  const rec = collectForm();
  addLocalSlipRecord(rec);
  // attempt server save in background (keeps original flow)
  (async()=>{ try{ await fetch(CREATE_ENDPOINT, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'save_data_only', slip: rec}), keepalive:true}).catch(()=>null); }catch(e){} })();
  // render preview and fit
  renderSlipToDom(rec);
  slipOutput.style.display='block';
  setTimeout(()=> fitSlipPreview(), 80);
});

/* print & close */
printBtn.addEventListener('click', ()=>{ setTimeout(()=> window.print(), 80); });
closeBtn.addEventListener('click', ()=>{ slipOutput.style.display='none'; });

/* list rendering */
function renderSlipsTable(slips){
  recordsBody.innerHTML=''; let total=0;
  (slips||[]).forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td style="width:60px">${s.id}</td><td style="width:160px">${(new Date(s.createdAt)).toLocaleString()}</td><td style="width:140px">${s.vehicleNo||'-'}</td><td style="width:120px">${s.filename? 'Saved':'-'}</td><td style="width:150px" id="amountCell_${s.id}">${s.amount?`₹ ${Number(s.amount).toFixed(2)}`:`<input type="number" step="0.01" min="0" id="amt_in_${s.id}" class="amount-input"><button class="btn btn-blue amount-submit" id="amt_btn_${s.id}" data-id="${s.id}">Submit</button>`}</td><td style="width:160px"><span style="color:#666">—</span></td>`;
    recordsBody.appendChild(tr);
    total += Number(s.amount||0);
  });
  totalAmountEl.textContent = total.toFixed(2);
  // attach handlers
  (window._slips||[]).forEach(s=>{
    const btn=document.getElementById(`amt_btn_${s.id}`);
    if(btn){
      btn.addEventListener('click', ()=>{
        const input=document.getElementById(`amt_in_${s.id}`);
        const val=input.value;
        if(val===''||isNaN(Number(val))){ alert('Enter valid amount'); return; }
        for(let i=0;i<window._slips.length;i++){ if(String(window._slips[i].id)===String(s.id)){ window._slips[i].amount = Number(val).toFixed(2); break; } }
        persistLocalSlips(); loadLocalSlips(); renderSlipsTable(window._slips);
      });
    }
  });
}
async function refreshList(){
  // attempt server list first; if server returns valid array, use that; otherwise use local storage
  try{
    const q = new URLSearchParams({ from:getVal('filterFrom')||'', to:getVal('filterTo')||'' });
    const resp = await fetch(LIST_ENDPOINT + '?' + q.toString());
    const j = await resp.json().catch(()=>null);
    if(j && Array.isArray(j.slips)){ renderSlipsTable(j.slips); window._slips = j.slips; persistLocalSlips(); return; }
  }catch(e){ /* ignore */ }
  loadLocalSlips();
  renderSlipsTable(window._slips);
}

/* initial */
refreshList();
</script>
</body>
</html>
