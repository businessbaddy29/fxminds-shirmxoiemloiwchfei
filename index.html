<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure Slip — Final Update</title>

<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ===== Base ===== */
html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:transparent; color:#0d2433;}
body::before{
  content:""; position: fixed; inset:0; z-index:-3;
  background-image: url("truck.avif"); background-size:cover; background-position:center; filter: blur(6px) brightness(.95);
}
body::after{
  content:""; position: fixed; inset:0; z-index:-2;
  background: linear-gradient(rgba(255,255,255,0.66), rgba(255,255,255,0.66));
}

.container { max-width:1100px; margin:22px auto; padding-bottom:60px; }

/* Card */
.card { background: linear-gradient(180deg,#fff,#fbfdff); padding:16px; border-radius:12px; box-shadow:0 8px 30px rgba(22,40,60,0.06); border:1px solid rgba(10,18,30,0.04); margin-bottom:18px; }

/* Login */
.loginBox h2 { margin:0 0 12px 0; color:#0b2330; font-size:20px; }
.loginBox input { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid rgba(20,30,40,0.06); font-family:"Courier New", monospace; }
.loginBox button { width:100%; padding:10px; border-radius:8px; border:none; background:#0b63b3; color:#fff; font-weight:600; cursor:pointer; }

/* Form full-width (as requested) */
.form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:center; }
.form-row { display:flex; gap:8px; }
label { display:block; color:#0b2330; font-size:14px; margin-top:8px; }
input[type="text"], input[type="date"] { width:100%; padding:8px; border-radius:6px; border:1px solid rgba(20,30,40,.06); font-family:"Courier New", monospace; box-sizing:border-box; }

/* Make two time fields appear on same row compactly */
.time-row { display:flex; gap:8px; }
.time-row input { flex:1; }

/* Buttons */
.controls { display:flex; gap:8px; margin-top:10px; }
.btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
.btn-blue { background: linear-gradient(180deg,#1976d2,#0b63b3); color:#fff; }
.btn-ghost { background:transparent; border:1px solid rgba(10,18,30,0.06); color:#07304b; }

/* Saved slips section is below form and hidden by default */
#recordsWrap { display:none; margin-top:8px; }

/* Table */
.table { width:100%; border-collapse:collapse; margin-top:8px; }
.table th, .table td { padding:10px 8px; text-align:left; border-bottom:1px solid rgba(10,18,30,0.04); font-size:14px; }
.table th { color:#07304b; font-weight:700; }

/* Slip preview overlay */
#slipOutput {
  display:none; position: fixed; left:50%; top:6%; transform:translateX(-50%);
  width: min(880px, 96%); max-height:88vh; overflow:auto; z-index:9999;
  border-radius:8px; box-shadow:0 20px 60px rgba(0,0,0,0.35); background:transparent;
}
#previewToolbar { display:flex; gap:8px; padding:8px; justify-content:flex-end; background: rgba(12,20,30,0.03); border-top-left-radius:8px; border-top-right-radius:8px; }
#slipInner { background:#fff; padding:18px; border-radius:8px; font-family:"Courier New", monospace; color:#000; box-sizing:border-box; }

/* Print styling — portrait A4 friendly and make slip fill page */
@page { size: A4 portrait; margin: 8mm; }
@media print {
  html,body { height:auto !important; }
  body * { visibility: hidden !important; }
  #slipOutput, #slipOutput * { visibility: visible !important; }
  #slipOutput { position: absolute !important; left:0 !important; top:0 !important; width:100% !important; height:100% !important; margin:0 !important; padding:0 !important; background:#fff !important; box-shadow:none !important; }
  #slipInner { padding: 12mm !important; border-radius:0 !important; box-shadow:none !important; width:100% !important; height:auto !important; overflow:visible !important; page-break-inside: avoid; -webkit-print-color-adjust: exact; }
  #previewToolbar { display:none !important; }
}

/* Responsive small screens */
@media (max-width:720px){
  .form-grid { grid-template-columns: 1fr; }
  .time-row { flex-direction:column; }
  #slipOutput { top:4%; }
}
</style>
</head>
<body>

<div class="container">

  <!-- LOGIN CARD -->
  <div class="card loginBox" id="loginBox">
    <h2>Login</h2>
    <input id="username" placeholder="User ID" autocomplete="off" />
    <input id="password" placeholder="Password" type="password" autocomplete="off" />
    <button id="loginBtn" class="btn btn-blue">Login</button>
    <p id="loginErr" style="color:#d33; display:none; margin-top:8px;">Invalid credentials</p>
  </div>

  <!-- FORM CARD (full width, top) -->
  <div class="card" id="formCard" style="display:none;">
    <form id="slipForm" onsubmit="return false;">
      <label>Firm Name: <input type="text" id="firmName" value="FIRM NAME" required></label>
      <label>Firm Address: <input type="text" id="firmAddress" value="FIRM ADDRESS"></label>

      <div class="form-grid">
        <label>RST No: <input type="text" id="rstNo" value="101"></label>
        <label>Vehicle No: <input type="text" id="vehicleNo" value="RJ32GE0903"></label>
      </div>

      <div class="form-grid">
        <label>Vehicle Type: <input type="text" id="vehicleType"></label>
        <label>Party Name: <input type="text" id="partyName"></label>
      </div>

      <div class="form-grid">
        <label>Address: <input type="text" id="address"></label>
        <label>Item: <input type="text" id="item" value="20MM"></label>
      </div>

      <div class="form-grid">
        <label>Gross (weight): <input type="text" id="gross" value="70680 Kg"></label>
        <label>Gross Date: <input type="text" id="grossDate" value="29/07/2025"></label>
      </div>

      <!-- BOTH TIMES ON SAME ROW as requested -->
      <div class="time-row" style="margin-top:6px;">
        <div style="flex:1">
          <label>Gross Time (enter exactly): <input type="text" id="grossTime" placeholder="e.g. 13:37 or 1:37 PM"></label>
        </div>
        <div style="flex:1">
          <label>Tare Time (enter exactly): <input type="text" id="tareTime" placeholder="e.g. 13:45"></label>
        </div>
      </div>

      <div class="form-grid">
        <label>Tare (weight): <input type="text" id="tare" value="15700 Kg"></label>
        <label>Tare Date: <input type="text" id="tareDate" value="29/07/2025"></label>
      </div>

      <label>Net: <input type="text" id="net" value="54980 Kg"></label>
      <label>Charges: Rs <input type="text" id="charges" value="0"></label>
      <label>Phone: <input type="text" id="phone" value="123456"></label>

      <div class="controls">
        <button type="button" id="printBtn" class="btn btn-blue">Print Slip & Save</button>
        <button type="button" id="previewBtn" class="btn btn-ghost">Preview Slip</button>
        <button type="button" id="toggleRecordsBtn" class="btn btn-ghost" style="margin-left:auto">Show Saved Slips</button>
        <button type="button" id="logoutBtn" class="btn btn-ghost">Logout</button>
      </div>
    </form>
  </div>

  <!-- SAVED SLIPS (below form) -->
  <div class="card" id="dashboardCard" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div style="font-size:18px; font-weight:700; color:#072033">Saved Slips</div>
        <div style="font-size:13px; color:#235">Read-only — use export buttons below.</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="font-size:13px; color:#07304b;">From</label>
        <input type="date" id="filterFrom">
        <label style="font-size:13px; color:#07304b;">To</label>
        <input type="date" id="filterTo">
        <button id="applyFilter" class="btn btn-ghost">Apply</button>
        <button id="exportPdfBtn" class="btn btn-blue">Download Filtered PDF</button>
        <button id="exportCsvBtn" class="btn btn-ghost">Export CSV</button>
      </div>
    </div>

    <div id="recordsWrap" style="margin-top:12px; display:none;">
      <div style="display:flex; gap:12px; margin-bottom:8px;">
        <div style="font-weight:700">Total: <span id="totalAll">0</span></div>
        <div style="font-weight:700">Filtered: <span id="totalFiltered">0</span></div>
        <div id="dateRangeText">Range: -</div>
      </div>

      <table class="table" id="recordsTable" aria-live="polite">
        <thead><tr><th>Sr</th><th>Date</th><th>Vehicle</th><th>Firm</th><th>Times</th><th>Action</th></tr></thead>
        <tbody id="recordsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Slip preview overlay -->
<div id="slipOutput" role="dialog" aria-modal="true">
  <div id="previewToolbar">
    <button id="closePreviewBtn" class="btn btn-blue">Close</button>
    <button id="downloadPdfPreview" class="btn btn-blue">Download PDF</button>
    <button id="printPreviewBtn" class="btn btn-blue">Print</button>
  </div>

  <div id="slipInner">
    <div id="slipContent" style="white-space:pre; font-family:Courier, monospace; color:#000;"></div>
  </div>
</div>

<script>
/* ==================== IndexedDB (unchanged) ==================== */
const DB_NAME = 'secure_slips_db_v1';
const STORE_NAME = 'slips';
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)){ const s=db.createObjectStore(STORE_NAME,{keyPath:'id',autoIncrement:true}); s.createIndex('savedAt','savedAt',{unique:false}); } }; r.onsuccess=e=>res(e.target.result); r.onerror=e=>rej(e.target.error); }); }
async function addSlipToDB(record){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); const store=tx.objectStore(STORE_NAME); const toStore=Object.assign({}, record); const req=store.add(toStore); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); }
async function getAllSlips(){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readonly'); const store=tx.objectStore(STORE_NAME); const req=store.getAll(); req.onsuccess=()=>res(req.result.sort((a,b)=>a.id-b.id)); req.onerror=()=>rej(req.error); }); }
async function getSlipsInRange(fromISO,toISO){ const all=await getAllSlips(); if(!fromISO && !toISO) return all; const from=fromISO?new Date(fromISO+'T00:00:00'):new Date('1970-01-01'); const to=toISO?new Date(toISO+'T23:59:59'):new Date('9999-12-31'); return all.filter(r=>{ const d=new Date(r.savedAt); return d>=from && d<=to; }); }

/* ==================== UI elements ==================== */
const USERNAME = "FxMiNds";
const PASSWORD = "Sk@#9136332836@";
let isLoggedIn=false;
let cachedAll=[];

const loginBtn = document.getElementById('loginBtn');
const loginErr = document.getElementById('loginErr');
const loginBox = document.getElementById('loginBox');
const formCard = document.getElementById('formCard');
const dashboardCard = document.getElementById('dashboardCard');

const mainPrintBtn = document.getElementById('printBtn') || document.getElementById('printBtn');
const previewBtn = document.getElementById('previewBtn');
const toggleRecordsBtn = document.getElementById('toggleRecordsBtn');
const logoutBtn = document.getElementById('logoutBtn');

const slipOutput = document.getElementById('slipOutput');
const slipContent = document.getElementById('slipContent');

const closePreviewBtn = document.getElementById('closePreviewBtn');
const printPreviewBtn = document.getElementById('printPreviewBtn');
const downloadPdfPreview = document.getElementById('downloadPdfPreview');

const recordsWrap = document.getElementById('recordsWrap');
const recordsBody = document.getElementById('recordsBody');

const applyFilterBtn = document.getElementById('applyFilter');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const exportCsvBtn = document.getElementById('exportCsvBtn');
const totalAllEl = document.getElementById('totalAll');
const totalFilteredEl = document.getElementById('totalFiltered');
const dateRangeText = document.getElementById('dateRangeText');

/* ===== login/logout ===== */
loginBtn.addEventListener('click', async () => {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if(u === USERNAME && p === PASSWORD){
    isLoggedIn = true;
    loginBox.style.display = 'none';
    formCard.style.display = 'block';
    dashboardCard.style.display = 'block';
    recordsWrap.style.display = 'none';
    toggleRecordsBtn.textContent = 'Show Saved Slips';
    await refreshList();
  } else {
    loginErr.style.display = 'block';
    setTimeout(()=>loginErr.style.display='none',2000);
  }
});
logoutBtn.addEventListener('click', () => {
  isLoggedIn = false;
  loginBox.style.display = 'block';
  formCard.style.display = 'none';
  dashboardCard.style.display = 'none';
  slipOutput.style.display = 'none';
  document.getElementById('username').value='';
  document.getElementById('password').value='';
});

/* ===== collect form (both times preserved exactly) ===== */
function collectForm(){
  return {
    firmName: document.getElementById('firmName').value,
    firmAddress: document.getElementById('firmAddress').value,
    rstNo: document.getElementById('rstNo').value,
    vehicleNo: document.getElementById('vehicleNo').value,
    vehicleType: document.getElementById('vehicleType').value,
    partyName: document.getElementById('partyName').value,
    address: document.getElementById('address').value,
    item: document.getElementById('item').value,
    gross: document.getElementById('gross').value,
    grossDate: document.getElementById('grossDate').value,
    grossTime: document.getElementById('grossTime')?.value || '',
    tare: document.getElementById('tare').value,
    tareDate: document.getElementById('tareDate')?.value || '',
    tareTime: document.getElementById('tareTime')?.value || '',
    net: document.getElementById('net').value,
    charges: document.getElementById('charges').value,
    phone: document.getElementById('phone').value,
    savedAt: new Date().toISOString()
  };
}

/* ===== build slip text - ensure both times display exactly as entered ===== */
function buildSlipPlainText(data){
  const width = 80;
  function padCenter(text){
    const t = String(text || '');
    const left = Math.floor((width - t.length)/2);
    const right = width - t.length - left;
    return ' '.repeat(Math.max(0,left)) + t + ' '.repeat(Math.max(0,right));
  }
  let s = '';
  s += padCenter(data.firmName) + '\n';
  s += padCenter(data.firmAddress) + '\n';
  s += '.'.repeat(width) + '\n';
  s += (`RST No.     : ${data.rstNo || ''}`).padEnd(25) + (`Vehicle No.   : ${data.vehicleNo || ''}`) + '\n';
  s += (`Vehicle Type: ${data.vehicleType || ''}`).padEnd(25) + (`Party Name    : ${data.partyName || ''}`) + '\n';
  s += (`Address     : ${data.address || ''}`).padEnd(25) + (`Item          : ${data.item || ''}`) + '\n';
  s += '.'.repeat(width) + '\n';
  s += (`Gross :    ${data.gross || ''}`).padEnd(25) + (` Date: ${data.grossDate || ''}`).padEnd(20) + (`  Time: ${data.grossTime || ''}`) + '\n';
  s += (`Tare  :    ${data.tare || ''}`).padEnd(25) + (` Date: ${data.tareDate || ''}`).padEnd(20) + (`  Time: ${data.tareTime || ''}`) + '\n';
  s += (`Net   :    ${data.net || ''}`) + '\n';
  s += '.'.repeat(width) + '\n';
  s += (`Charges    : Rs ${data.charges || ''}`) + '\n';
  s += '.'.repeat(width) + '\n';
  s += (`                                  Phone : ${data.phone || ''}`) + '\n';
  s += padCenter('Thanks for your visit') + '\n';
  return s;
}

/* ===== preview / render ===== */
function renderSlipPreview(rec){
  document.getElementById('slipContent').textContent = buildSlipPlainText(rec);
  slipOutput.style.display = 'block';
  slipOutput.scrollIntoView({behavior:'smooth'});
}

/* ===== preview toolbar handlers ===== */
closePreviewBtn.addEventListener('click', ()=> slipOutput.style.display='none');
printPreviewBtn.addEventListener('click', ()=> {
  slipOutput.style.display = 'block';
  // allow rendering then print
  setTimeout(()=> window.print(), 150);
});
downloadPdfPreview.addEventListener('click', async ()=> {
  slipOutput.style.display = 'block';
  const node = document.getElementById('slipInner');
  const canvas = await html2canvas(node, { scale:2, useCORS:true });
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'pt', format:'a4' });
  const imgProps = pdf.getImageProperties(img);
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  pdf.addImage(img, 'PNG', 10, 10, pdfWidth-20, pdfHeight-20);
  pdf.save(`slip_preview.pdf`);
});

/* ===== save & print button ===== */
document.getElementById('printBtn').addEventListener('click', async ()=>{
  if(!isLoggedIn){ alert('Please login first'); return; }
  const rec = collectForm();
  const id = await addSlipToDB(rec);
  rec._serial = id;
  await refreshList();
  renderSlipPreview(rec);
  setTimeout(()=> { slipOutput.style.display='block'; window.print(); }, 450);
});

/* preview only */
previewBtn.addEventListener('click', ()=>{
  if(!isLoggedIn){ alert('Please login first'); return; }
  const rec = collectForm();
  renderSlipPreview(rec);
});

/* toggle records view */
toggleRecordsBtn.addEventListener('click', async ()=>{
  if(recordsWrap.style.display === 'none' || recordsWrap.style.display === '') {
    recordsWrap.style.display = 'block';
    toggleRecordsBtn.textContent = 'Hide Saved Slips';
    await applyFilter();
  } else {
    recordsWrap.style.display = 'none';
    toggleRecordsBtn.textContent = 'Show Saved Slips';
  }
});

/* refresh list */
async function refreshList(){
  cachedAll = await getAllSlips();
  totalAllEl.textContent = cachedAll.length;
  await applyFilter();
}

/* apply filter & populate table */
applyFilterBtn.addEventListener('click', applyFilter);
async function applyFilter(){
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const filtered = await getSlipsInRange(from, to);
  totalFilteredEl.textContent = filtered.length;
  dateRangeText.textContent = (from||'-') + ' → ' + (to||'-');
  recordsBody.innerHTML = '';
  filtered.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="width:60px">${r.id}</td>
      <td>${new Date(r.savedAt).toLocaleDateString()}</td>
      <td>${r.vehicleNo||'-'}</td>
      <td>${r.firmName||'-'}</td>
      <td>${(r.grossTime||'')}${(r.tareTime? ' / ' + r.tareTime : '')}</td>
      <td style="width:160px">
        <button class="btn btn-ghost" data-id="${r.id}" data-action="view">View</button>
        <button class="btn btn-blue" data-id="${r.id}" data-action="pdf">PDF</button>
      </td>`;
    recordsBody.appendChild(tr);
  });
  // bind actions
  recordsBody.querySelectorAll('button').forEach(b=>{
    b.onclick = async (e)=>{
      const id = Number(e.currentTarget.dataset.id);
      const action = e.currentTarget.dataset.action;
      const rec = cachedAll.find(x=>x.id===id);
      if(!rec) return;
      if(action==='view'){ renderSlipPreview(rec); }
      if(action==='pdf'){ await downloadSingleRecAsPdf(rec); }
    };
  });
}

/* export filtered PDF */
exportPdfBtn.addEventListener('click', async ()=>{
  if(!isLoggedIn){ alert('Please login first'); return; }
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const filtered = await getSlipsInRange(from, to);
  if(filtered.length===0){ alert('No slips in selected range'); return; }
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'pt', format:'a4' });
  for(let i=0;i<filtered.length;i++){
    const rec = filtered[i];
    document.getElementById('slipContent').textContent = buildSlipPlainText(rec);
    slipOutput.style.display='block';
    const canvas = await html2canvas(document.getElementById('slipInner'), { scale:2, useCORS:true });
    const img = canvas.toDataURL('image/png');
    const imgProps = pdf.getImageProperties(img);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    if(i>0) pdf.addPage();
    pdf.addImage(img, 'PNG', 10, 10, pdfWidth-20, pdfHeight-20);
    slipOutput.style.display='none';
  }
  pdf.save(`slips_${document.getElementById('filterFrom').value||'all'}_${document.getElementById('filterTo').value||'all'}.pdf`);
});

/* single record PDF */
async function downloadSingleRecAsPdf(rec){
  if(!isLoggedIn){ alert('Please login first'); return; }
  document.getElementById('slipContent').textContent = buildSlipPlainText(rec);
  slipOutput.style.display='block';
  const canvas = await html2canvas(document.getElementById('slipInner'), { scale:2, useCORS:true });
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'pt', format:'a4' });
  const imgProps = pdf.getImageProperties(img);
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  pdf.addImage(img, 'PNG', 10, 10, pdfWidth-20, pdfHeight-20);
  pdf.save(`slip_${rec.id}.pdf`);
  slipOutput.style.display='none';
}

/* CSV export */
exportCsvBtn.addEventListener('click', async ()=>{
  if(!isLoggedIn){ alert('Please login first'); return; }
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const rows = await getSlipsInRange(from, to);
  if(rows.length===0){ alert('No slips to export'); return; }
  const headers = ['id','savedAt','vehicleNo','firmName','gross','grossDate','grossTime','tare','tareDate','tareTime','net','charges','phone'];
  const csv = [headers.join(',')].concat(rows.map(r=> headers.map(h => `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `slips_${from||'all'}_${to||'all'}.csv`; a.click();
  URL.revokeObjectURL(url);
});

/* initial UI state */
window.addEventListener('load', ()=>{
  formCard.style.display='none';
  dashboardCard.style.display='none';
  slipOutput.style.display='none';
});
</script>

</body>
</html>
