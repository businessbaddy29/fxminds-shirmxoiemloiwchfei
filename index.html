<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Slip — Create Slip (FINAL - updated)</title>

  <!-- External libs (html2canvas/jspdf kept but not used for PDF output) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== layout & base ===== */
    html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:transparent; color:#0d2433; }
    .container { max-width:1100px; margin:22px auto; padding-bottom:60px; }
    .card { background: linear-gradient(180deg,#fff,#fbfdff); padding:16px; border-radius:12px; box-shadow:0 8px 30px rgba(22,40,60,0.06); border:1px solid rgba(10,18,30,0.04); margin-bottom:18px; }

    /* login & form */
    .loginBox h2{ margin:0 0 12px 0; color:#0b2330; font-size:20px; }
    .loginBox input{ width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid rgba(20,30,40,0.06); font-family:"Courier New",monospace; }
    .loginBox button{ width:100%; padding:10px; border-radius:8px; border:none; background:#0b63b3; color:#fff; font-weight:600; cursor:pointer; }

    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; align-items:center; }
    label{ display:block; color:#0b2330; font-size:14px; margin-top:8px; }
    input[type="text"], input[type="date"], input[type="number"], select { width:100%; padding:8px; border-radius:6px; border:1px solid rgba(20,30,40,.06); font-family:"Courier New",monospace; box-sizing:border-box; }
    .time-row { display:flex; gap:8px; }
    .time-row > div { flex:1; }

    .controls { display:flex; gap:8px; margin-top:10px; align-items:center; }
    .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .btn-blue { background: linear-gradient(180deg,#1976d2,#0b63b3); color:#fff; }
    .btn-ghost { background:transparent; border:1px solid rgba(10,18,30,0.06); color:#07304b; }

    /* slip preview overlay (centered) */
    #slipOutput {
      display:none;
      position:fixed;
      left:50%;
      top:6%;
      transform:translateX(-50%);
      z-index:9999;
      background:transparent;
      box-sizing:border-box;
      padding:6px;
    }
    #previewToolbar { display:flex; gap:8px; padding:8px; justify-content:flex-end; background: rgba(12,20,30,0.03); border-top-left-radius:8px; border-top-right-radius:8px; }
    #slipInner { background:#fff; border-radius:8px; color:#000; font-family:"Courier New",monospace; box-sizing:border-box; overflow:visible; transform-origin: top left; }

    /* ensure header centers despite variable length */
    .header-wrap { width:100%; box-sizing:border-box; padding:4px 0 8px 0; display:flex; justify-content:center; align-items:flex-start; }
    .header-inner { display:inline-block; text-align:center; max-width:90%; box-sizing:border-box; word-break:break-word; white-space:normal; }

    /* numeric fixed width for values so "0" doesn't overflow layout */
    .num { display:inline-block; min-width:40px; text-align:right; font-family:"Courier New",monospace; }

    .table { width:100%; border-collapse:collapse; margin-top:8px; }
    .table th, .table td { padding:8px 6px; text-align:left; border-bottom:1px solid rgba(10,18,30,0.04); font-size:13px; vertical-align:middle; }
    .table th { color:#07304b; font-weight:700; }

    .err { border-color:#d33 !important; box-shadow:0 0 0 3px rgba(211,51,51,0.08); }
    .errMsg { color:#d33; font-weight:700; margin-top:6px; font-size:13px; }

    /* page printing rules: fixed physical size 10in x 5in */
    @page { size: 10in 5in; margin: 0; }
    @media print {
      body * { visibility: hidden !important; }
      #slipOutput, #slipOutput * { visibility: visible !important; }
      #slipOutput { position: fixed !important; left:0 !important; top:0 !important; width:10in !important; height:5in !important; margin:0 !important; padding:0 !important; box-shadow:none !important; overflow:hidden !important; transform:none !important; }
      #slipInner { width:10in !important; height:5in !important; padding:0 !important; margin:0 !important; box-sizing:border-box !important; overflow:hidden !important; transform:none !important; }
    }

    .smallNote { font-size:12px; color:#666; margin-top:6px; }
    #serverError { margin-top:10px; color:#b33; font-weight:700; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div class="card loginBox" id="loginBox">
      <h2>Login</h2>
      <input id="username" placeholder="User ID" autocomplete="off" />
      <input id="password" placeholder="Password" type="password" autocomplete="off" />
      <button id="loginBtn" class="btn btn-blue">Login</button>
      <p id="loginErr" style="color:#d33; display:none; margin-top:8px;">Invalid credentials</p>
    </div>

    <!-- FORM -->
    <div class="card" id="formCard" style="display:none;">
      <form id="slipForm" onsubmit="return false;">
        <label>Firm Name: <input type="text" id="firmName" value="FIRM NAME" required></label>
        <div id="firmNameErr" class="errMsg" style="display:none">भाई इसे कोन भरेगा</div>

        <label>Firm Address: <input type="text" id="firmAddress" value="FIRM ADDRESS" required></label>
        <label>Firm Phone: <input type="text" id="firmPhone" placeholder="Enter firm phone (optional)"></label>
        <div id="firmAddressErr" class="errMsg" style="display:none">भाई इसे कोन भरेगा</div>

        <div class="form-grid">
          <label>RST No: <input type="text" id="rstNo" value="101" required></label>
          <label>Vehicle No: <input type="text" id="vehicleNo" value="RJ32GE0903" required></label>
        </div>

        <div class="form-grid">
          <label>Item: <input type="text" id="item" value="20MM" required></label>
          <label>Vehicle Type: <input type="text" id="vehicleType"></label>
          <label>Party Name: <input type="text" id="partyName" placeholder="Enter Party Name (optional)"></label>
        </div>

        <div class="form-grid">
          <label>Gross (weight): <input type="text" id="gross" value="70680 Kg"></label>
          <label>Gross Date: <input type="text" id="grossDate" value="2025-11-08"></label>
        </div>

        <div class="time-row" style="margin-top:6px;">
          <div style="flex:1">
            <label>Gross Time (enter exactly): <input type="text" id="grossTime" placeholder="e.g. 13:37"></label>
          </div>
          <div style="flex:1">
            <label>Tare Time (enter exactly): <input type="text" id="tareTime" placeholder="e.g. 13:45"></label>
          </div>
        </div>

        <div class="form-grid">
          <label>Tare (weight): <input type="text" id="tare" value="15700 Kg"></label>
          <label>Tare Date: <input type="text" id="tareDate" value="2025-11-08"></label>
        </div>

        <label>Net: <input type="text" id="net" value="54980 Kg"></label>
        <label>Charges: Rs <input type="text" id="charges" value="0"></label>
        <label>Phone: <input type="text" id="phone" value="123456"></label>

        <div class="controls">
          <button type="button" id="createBtn" class="btn btn-blue">Create Slip</button>
          <button type="button" id="logoutBtn" class="btn btn-ghost" style="margin-left:auto">Logout</button>
        </div>
        <div id="serverError"></div>
      </form>
    </div>

    <!-- SAVED SLIPS -->
    <div class="card" id="dashboardCard" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div>
          <div style="font-size:18px; font-weight:700; color:#072033">Saved Slips</div>
          <div style="font-size:13px; color:#235">Client & server records</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="font-size:13px; color:#07304b;">From</label>
          <input type="date" id="filterFrom">
          <label style="font-size:13px; color:#07304b;">To</label>
          <input type="date" id="filterTo">
          <button id="applyFilter" class="btn btn-ghost">Apply</button>
          <div style="font-weight:700">Total Amount: <span id="totalAmount">0</span></div>
        </div>
      </div>
      <div id="recordsWrap" style="margin-top:12px;">
        <table class="table" id="recordsTable" aria-live="polite">
          <thead>
            <tr><th>Sr</th><th>Date</th><th>Vehicle</th><th>Saved</th><th>Amount (₹)</th><th>Action</th></tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Slip preview overlay -->
  <div id="slipOutput" role="dialog" aria-modal="true" style="display:none">
    <div id="previewToolbar">
      <button id="printBtn" class="btn btn-blue">Print</button>
      <button id="downloadTxtBtn" class="btn btn-ghost">Download .txt</button>
      <button id="closePreviewBtn" class="btn btn-ghost">Close</button>
    </div>

    <!-- fixed physical size inside -->
    <div id="slipInner" style="width:10in; height:5in; padding:0; margin:0;">
      <div id="slipContent" style="color:#000; box-sizing:border-box; padding:6px;"></div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  // Constants
  const USERNAME = "FxMiNds";
  const PASSWORD = "Sk@#9136332836@";
  const SERVER_BASE = '/slip-server';
  const CREATE_ENDPOINT = buildServerUrl('/create_pdf.php');
  const LIST_ENDPOINT   = buildServerUrl('/get_slips.php');
  const AMOUNT_ENDPOINT = buildServerUrl('/update_amount.php');

  function buildServerUrl(path){
    const base = SERVER_BASE || '';
    if(base.startsWith('http://')||base.startsWith('https://')) return base + path;
    return window.location.origin + (base.startsWith('/')?base:('/'+base)) + path;
  }

  // Utility
  const $ = id => document.getElementById(id);
  function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function getVal(id){ const el = $(id); return el ? el.value : ''; }
  function safeNumString(s){ return String(s||''); } // keep zeros unchanged

  // Serial (13-digit sequential, persisted)
  function getNextSerial13(){
    const key = 'slip_serial_counter_v1';
    let n = Number(localStorage.getItem(key) || 0);
    n = n + 1;
    localStorage.setItem(key, String(n));
    return n;
  }
  function formatSerial13(n){
    return String(n).padStart(13,'0'); // 0000000000001 ...
  }

  // Template (kept same visual layout; header centered)
  const TEMPLATE_HTML = `
  <div style='font-family:"Courier New",monospace;color:#000;width:10in;box-sizing:border-box;padding:6px;'>
    <div class="header-wrap">
      <div class="header-inner">
        <span style="letter-spacing:2px; font-size:70px; font-weight:    ;">{{firmName}}</span>
                            <span style="font-size:45px;">{{firmAddress}}</span>
                                 <span style="font-size:45px;">{{firmPhone}}</span>
      </div>
    </div>

    <pre style='margin:10px 0 0 0; padding:6px; white-space:pre; font-family:"Courier New",monospace; line-height:1.15; font-size:14px;'>

_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
<span style="font-size:45px;">RST No.     : {{rstNo}}</span>                                   <span style="font-size:45px;">Vehicle No.     : {{vehicleNo}}</span>
<span style="font-size:45px;">Vh l typ.   : {{vehicleType}}</span>                                      <span style="font-size:45px;"> Party name      : {{partyName}}</span>
<span style="font-size:45px;">Address     : {{address}}</span>                                      <span style="font-size:45px;"> Item            : {{item}}</span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

<span style="font-size:45px;">Gross   :</span>      <span style="font-size:55px; font-weight:    ;">{{gross}}</span><span style="font-size:45px;"> Kg      Date  : {{grossDate}}</span>    <span style="font-size:45px;">  Time     :    {{grossTime}}</span>
<span style="font-size:45px;">Tare    :</span>      <span style="font-size:55px; font-weight:    ;">{{tare}}</span><span style="font-size:45px;"> Kg      Date  : {{tareDate}}</span>       <span style="font-size:45px;">Time     :    {{tareTime}}</span>
<span style="font-size:45px;">Net     :</span>      <span style="font-size:55px; font-weight:    ;">{{net}}</span>  <span style="font-size:45px;">Kg</span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
<span style="font-size:45px;">Charges : Rs {{charges}}</span>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

                                            <span style="font-size:45px;">Phone : {{phone}}</span>

                                         <span style="font-size:45px;">Thanks for your visit</span>
  </pre>
</div>
`;

  // State
  let isLoggedIn = false;
  window._slips = window._slips || []; // runtime array

  // DOMContentLoaded init to avoid timing errors
  window.addEventListener('DOMContentLoaded', () => {
    try {
      // Element refs
      const loginBtn = $('loginBtn');
      const logoutBtn = $('logoutBtn');
      const loginBox = $('loginBox');
      const formCard = $('formCard');
      const dashboardCard = $('dashboardCard');
      const createBtn = $('createBtn');
      const closePreviewBtn = $('closePreviewBtn');
      const printBtn = $('printBtn');
      const downloadTxtBtn = $('downloadTxtBtn');
      const slipOutput = $('slipOutput');
      const slipInner = $('slipInner');
      const slipContent = $('slipContent');

      // Attach login
      if(loginBtn){
        loginBtn.addEventListener('click', ()=>{
          const u = String(getVal('username')).trim();
          const p = String(getVal('password')).trim();
          console.log('[login] attempt: user=', u, ' pwdlen=', p.length);
          if(u === USERNAME && p === PASSWORD){
            isLoggedIn = true;
            if(loginBox) loginBox.style.display = 'none';
            if(formCard) formCard.style.display = 'block';
            if(dashboardCard) dashboardCard.style.display = 'block';
            refreshList().catch(()=>{});
            console.log('[login] success');
          } else {
            console.warn('[login] invalid credentials');
            const loginErr = $('loginErr');
            if(loginErr){ loginErr.style.display = 'block'; setTimeout(()=>loginErr.style.display='none',2000); }
          }
        });
      }

      if(logoutBtn){
        logoutBtn.addEventListener('click', ()=>{
          isLoggedIn = false;
          if(loginBox) loginBox.style.display = 'block';
          if(formCard) formCard.style.display = 'none';
          if(dashboardCard) dashboardCard.style.display = 'none';
        });
      }

      // recomputeGross
      const grossEl = $('gross'), tareEl = $('tare'), netEl = $('net');
      function recomputeGross(){
        const tare = Number((tareEl && tareEl.value) ? tareEl.value.replace(/[^0-9.-]/g,'') : 0) || 0;
        const net  = Number((netEl && netEl.value) ? netEl.value.replace(/[^0-9.-]/g,'') : 0) || 0;
        const gross = tare + net;
        if(grossEl) grossEl.value = `${Number(gross).toFixed(0)} Kg`;
      }
      if(tareEl) tareEl.addEventListener('input', recomputeGross);
      if(netEl) netEl.addEventListener('input', recomputeGross);
      recomputeGross();

      // Create slip (render preview + save client record + optional server save)
      if(createBtn){
        createBtn.addEventListener('click', async ()=>{
          try {
            if(!isLoggedIn){ alert('Please login first'); return; }
            if(!validateAll()){ const firstErr = requiredMap.find(i=>{ const el = $(i.id); return el && el.classList.contains('err'); }); if(firstErr) $(firstErr.id).scrollIntoView({behavior:'smooth',block:'center'}); return; }

            createBtn.disabled = true;
            createBtn.textContent = 'Preparing...';

            const rec = collectForm();

            // build rendered HTML
            let rendered = TEMPLATE_HTML;
            const replacements = {
              '{{firmName}}': esc(rec.firmName || ''),
              '{{firmAddress}}': esc(rec.firmAddress || ''),
              '{{firmPhone}}': esc(safeNumString(rec.firmPhone||'')),
              '{{rstNo}}': esc(safeNumString(rec.rstNo||'')),
              '{{vehicleNo}}': esc(safeNumString(rec.vehicleNo||'')),
              '{{vehicleType}}': esc(rec.vehicleType||''),
              '{{partyName}}': esc(rec.partyName||''),
              '{{address}}': esc(rec.address||''),
              '{{item}}': esc(safeNumString(rec.item||'')),
              '{{gross}}': esc(String(rec.gross||'').replace(/\s*Kg$/i,'')),
              '{{grossDate}}': esc(rec.grossDate||''),
              '{{grossTime}}': esc(rec.grossTime||''),
              '{{tare}}': esc(String(rec.tare||'').replace(/\s*Kg$/i,'')),
              '{{tareDate}}': esc(rec.tareDate||''),
              '{{tareTime}}': esc(rec.tareTime||''),
              '{{net}}': esc(String(rec.net||'').replace(/\s*Kg$/i,'')),
              '{{charges}}': esc(safeNumString(rec.charges||'')),
              '{{phone}}': esc(safeNumString(rec.phone||''))
            };
            Object.keys(replacements).forEach(k=>{ rendered = rendered.split(k).join(replacements[k]); });

            slipContent.innerHTML = rendered;

            // ensure physical dimensions for preview container
            slipInner.style.width = '10in';
            slipInner.style.height = '5in';
            slipInner.style.padding = '0';
            slipInner.style.margin = '0';
            slipInner.style.boxSizing = 'border-box';
            slipInner.style.overflow = 'hidden';

            // scale preview to fit viewport
            showPreviewScaled();

            // add saved record (client-side) with 13-digit serial
            const seq = getNextSerial13();
            const serial = formatSerial13(seq);
            const now = new Date();
            const recItem = {
              id: seq,
              serial: serial,
              createdAt: now.toISOString(),
              vehicleNo: rec.vehicleNo || '',
              amount: rec.amount || ''
            };
            // push at top
            window._slips = window._slips || [];
            window._slips.unshift(recItem);
            renderSlipsTable(window._slips);

            // server save: non-blocking simple JSON POST (no pdf)
            (async ()=>{
              try {
                const payload = { vehicleNo: rec.vehicleNo || '', rstNo: rec.rstNo || '', createdAt: new Date().toISOString(), amount: rec.amount || '', meta: rec };
                await fetch(CREATE_ENDPOINT, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
              } catch(e){ /* ignore server errors */ }
            })();
          } catch(err){
            console.error('create error', err);
            alert('Error preparing preview — check console.');
          } finally {
            createBtn.disabled = false;
            createBtn.textContent = 'Create Slip';
          }
        });
      }

      // Print button: temporarily remove scaling so print uses real size
      if(printBtn){
        printBtn.addEventListener('click', ()=>{
          // store transforms
          const oldTransform = slipInner.style.transform;
          const oldWrapper = slipOutput.style;
          // set to physical position
          slipInner.style.transform = 'none';
          slipOutput.style.left = '0';
          slipOutput.style.top = '0';
          slipOutput.style.transform = 'none';
          slipOutput.style.width = '10in';
          slipOutput.style.height = '5in';
          // call print
          window.print();
          // restore scaled preview (small timeout for print dialog)
          setTimeout(()=>{ showPreviewScaled(); }, 400);
        });
      }

      // Download .txt from preview (optional)
      if(downloadTxtBtn){
        downloadTxtBtn.addEventListener('click', ()=>{
          try {
            const pre = slipContent.querySelector('pre');
            const text = pre ? pre.textContent : slipContent.innerText || '';
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `slip_${Date.now()}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          } catch(e){ console.error('download txt', e); alert('Download failed'); }
        });
      }

      if(closePreviewBtn){
        closePreviewBtn.addEventListener('click', ()=> { slipOutput.style.display = 'none'; slipInner.style.transform = 'none'; });
      }

      // showPreviewScaled: scale slipInner so full single page fits viewport
      function showPreviewScaled(){
        const PAGE_W_PX = 10 * 96; // CSS inch -> px (approx)
        const PAGE_H_PX = 5 * 96;
        const availW = Math.max(320, Math.min(window.innerWidth * 0.96, window.innerWidth));
        const availH = Math.max(200, Math.min(window.innerHeight * 0.88, window.innerHeight));
        const scaleW = availW / PAGE_W_PX;
        const scaleH = availH / PAGE_H_PX;
        const scale = Math.min(1, scaleW, scaleH);

        slipInner.style.transformOrigin = 'top left';
        slipInner.style.transform = `scale(${scale})`;

        // wrapper size equals scaled page size so it centers well
        slipOutput.style.width = Math.ceil(PAGE_W_PX * scale) + 'px';
        slipOutput.style.height = Math.ceil(PAGE_H_PX * scale) + 'px';
        slipOutput.style.left = '50%';
        slipOutput.style.top = '6%';
        slipOutput.style.transform = 'translateX(-50%)';
        slipOutput.style.display = 'block';
      }

      // Validation: same requiredMap as before
      window.requiredMap = [
        { id: 'firmName', err: 'firmNameErr' },
        { id: 'firmAddress', err: 'firmAddressErr' },
        { id: 'rstNo', err: 'rstErr' },
        { id: 'vehicleNo', err: 'vehErr' },
        { id: 'item', err: 'itemErr' },
        { id: 'gross', err: 'grossErr' },
        { id: 'grossDate', err: 'grossDateErr' },
        { id: 'grossTime', err: 'grossTimeErr' },
        { id: 'tareTime', err: 'tareTimeErr' },
        { id: 'tare', err: 'tareErr' },
        { id: 'tareDate', err: 'tareDateErr' },
        { id: 'net', err: 'netErr' }
      ];

      function clearValidation(){
        requiredMap.forEach(item => {
          const el = $(item.id); if(el) el.classList.remove('err');
          const en = $(item.err); if(en) en.style.display = 'none';
        });
        const se = $('serverError'); if(se) { se.style.display='none'; se.textContent=''; }
      }

      function validateAll(){
        clearValidation();
        let ok = true;
        for(const item of requiredMap){
          const el = $(item.id);
          const errNode = $(item.err);
          if(!el){
            if(errNode) errNode.style.display = 'block';
            ok = false;
            continue;
          }
          const val = String(el.value || '').trim();
          if(item.id === 'gross'){
            if(!val || !val.match(/[0-9]/)){
              ok = false; el.classList.add('err'); if(errNode) errNode.style.display = 'block';
            }
          } else {
            if(val === ''){
              ok = false; el.classList.add('err'); if(errNode) errNode.style.display = 'block';
            }
          }
        }
        return ok;
      }

      // collect form
      function collectForm(){
        const tareNum = Number(getVal('tare') ? getVal('tare').replace(/[^0-9.-]/g,'') : 0) || 0;
        const netNum  = Number(getVal('net') ? getVal('net').replace(/[^0-9.-]/g,'') : 0) || 0;
        const grossNum = tareNum + netNum;
        return {
          firmName: getVal('firmName'),
          firmAddress: getVal('firmAddress'),
          firmPhone: getVal('firmPhone'),
          rstNo: getVal('rstNo'),
          vehicleNo: getVal('vehicleNo'),
          vehicleType: getVal('vehicleType'),
          partyName: getVal('partyName'),
          address: getVal('address'),
          item: getVal('item'),
          gross: `${Number(grossNum).toFixed(0)} Kg`,
          grossDate: getVal('grossDate'),
          grossTime: getVal('grossTime'),
          tare: `${Number(tareNum).toFixed(0)} Kg`,
          tareDate: getVal('tareDate'),
          tareTime: getVal('tareTime'),
          net: `${Number(netNum).toFixed(0)} Kg`,
          amount: '',
          charges: getVal('charges'),
          phone: getVal('phone'),
          savedAt: new Date().toISOString()
        };
      }

      window.collectForm = collectForm;
      window.validateAll = validateAll;
      window.clearValidation = clearValidation;

      // Saved list rendering
      async function refreshList(){
        try {
          // try server first
          const from = getVal('filterFrom') || '';
          const to = getVal('filterTo') || '';
          const q = new URLSearchParams({ from, to });
          const resp = await fetch(LIST_ENDPOINT + '?' + q.toString());
          const json = await resp.json();
          if(!json || !Array.isArray(json.slips)){
            // fallback: use client list
            if(window._slips && window._slips.length) renderSlipsTable(window._slips);
            return;
          }
          const slips = json.slips.slice();
          slips.sort((a,b)=>{ if(a.id!=null && b.id!=null) return Number(b.id)-Number(a.id); return (new Date(b.createdAt)).getTime() - (new Date(a.createdAt)).getTime(); });
          window._slips = slips;
          renderSlipsTable(slips);
        } catch(err){
          console.warn('refreshList failed', err);
          if(window._slips && window._slips.length) renderSlipsTable(window._slips);
        }
      }
      window.refreshList = refreshList;

      function renderSlipsTable(slips){
        const tbody = $('recordsBody');
        tbody.innerHTML = '';
        let totalAmt = 0;
        slips.sort((a,b)=>{ if(a.id!=null && b.id!=null) return Number(b.id)-Number(a.id); return (new Date(b.createdAt)).getTime() - (new Date(a.createdAt)).getTime(); });
        slips.forEach(s=>{
          const tr = document.createElement('tr');
          const displaySr = s.serial ? s.serial : String(Number(s.id||0)).padStart(13,'0');
          const date = s.createdAt ? (new Date(s.createdAt)).toLocaleString() : '-';
          tr.innerHTML = `<td style="width:120px">${displaySr}</td>
            <td style="width:120px">${date}</td>
            <td style="width:140px">${esc(s.vehicleNo||'-')}</td>
            <td style="width:200px">${'Saved'}</td>
            <td style="width:150px" id="amountCell_${s.id}">${ s.amount !== undefined && s.amount !== null && s.amount !== '' ? `<span>₹ ${Number(s.amount).toFixed(2)}</span>` : `<input type="number" step="0.01" min="0" id="amt_in_${s.id}" class="amount-input" placeholder="0.00"><button class="btn btn-blue amount-submit" id="amt_btn_${s.id}" data-id="${s.id}">Submit</button>` }</td>
            <td style="width:160px"><button class="btn btn-ghost" data-id="${s.id}" data-action="download">Download</button></td>`;
          tbody.appendChild(tr);
          totalAmt += Number(s.amount || 0);
        });
        $('totalAmount').textContent = totalAmt.toFixed(2);
        window._slips = slips;

        // attach download handlers
        tbody.querySelectorAll('button[data-action="download"]').forEach(b=>{
          b.onclick = (e)=>{
            const id = Number(e.currentTarget.dataset.id);
            const row = (window._slips || []).find(x=>x.id === id);
            if(row && row.filepath) window.open(row.filepath,'_blank');
            else alert('No file link available for this record.');
          };
        });

        // attach amount submit handlers
        (window._slips || []).forEach(s=>{
          const btn = document.getElementById(`amt_btn_${s.id}`);
          if(btn){
            btn.addEventListener('click', async (ev)=>{
              const id = Number(ev.currentTarget.dataset.id);
              const input = document.getElementById(`amt_in_${id}`);
              const val = input.value;
              if(val === '' || isNaN(Number(val))){ alert('Enter valid amount'); return; }
              try{
                const resp = await fetch(AMOUNT_ENDPOINT, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ id, amount: Number(val) }) });
                const j = await resp.json();
                if(j && j.ok){ alert('Amount saved.'); await refreshList(); } else alert('Could not save amount (server).');
              }catch(err){ console.error(err); alert('Error saving amount.'); }
            });
          }
        });
      }
      window.renderSlipsTable = renderSlipsTable;

      // initial loading: restore client-side saved slips if any
      try {
        const clientList = JSON.parse(localStorage.getItem('client_slips_v1') || 'null');
        if(Array.isArray(clientList) && clientList.length){ window._slips = clientList.concat(window._slips || []); renderSlipsTable(window._slips); }
      } catch(e){ /* ignore */ }

      // Persist saved slips to localStorage whenever window._slips changes (simple interval flush)
      setInterval(()=> {
        try { localStorage.setItem('client_slips_v1', JSON.stringify(window._slips || [])); } catch(e){}
      }, 2000);

      // helper: next serial functions in global scope
      window.getNextSerial13 = getNextSerial13;
      window.formatSerial13 = formatSerial13;

      // small UI hint: on load hide form & dashboard
      $('formCard').style.display = 'none';
      $('dashboardCard').style.display = 'none';

    } catch(initErr){
      console.error('Init error', initErr);
      alert('Initialization error — open console and paste the error here.');
    }
  }); // DOMContentLoaded

})(); // IIFE
</script>

</body>
</html>
